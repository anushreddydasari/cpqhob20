<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewing Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }
        .debug-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .debug-section h3 {
            color: #667eea;
            margin-top: 0;
        }
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #5a6fd8;
        }
        .button.secondary {
            background: #6c757d;
        }
        .button.secondary:hover {
            background: #5a6268;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .result-box {
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .success {
            color: #155724;
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .warning {
            color: #856404;
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        .pdf-viewer {
            width: 100%;
            height: 600px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç PDF Viewing Debug Tool</h1>
            <p>Debug PDF viewing issues in production environment</p>
        </div>

        <div class="debug-section">
            <h3>üìä System Status</h3>
            <button class="button" onclick="checkSystemStatus()">Check System Status</button>
            <button class="button secondary" onclick="checkFileStorage()">Check File Storage</button>
            <button class="button secondary" onclick="checkEnvironment()">Check Environment</button>
            <div id="systemStatus" class="result-box" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>üìÑ PDF Testing</h3>
            <button class="button" onclick="testPdfGeneration()">Test PDF Generation</button>
            <button class="button secondary" onclick="testPdfPreview()">Test PDF Preview</button>
            <button class="button secondary" onclick="testPdfDownload()">Test PDF Download</button>
            <div id="pdfTestResults" class="result-box" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>üîß Manual PDF Testing</h3>
            <label for="testDocumentId">Document ID to test:</label>
            <input type="text" id="testDocumentId" placeholder="Enter document ID" style="padding: 8px; margin: 10px; width: 200px;">
            <button class="button" onclick="testSpecificDocument()">Test This Document</button>
            <div id="manualTestResults" class="result-box" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>üìã PDF Viewer</h3>
            <div id="pdfViewerContainer" style="display: none;">
                <iframe id="pdfViewer" class="pdf-viewer" frameborder="0"></iframe>
                <div style="margin-top: 10px;">
                    <button class="button secondary" onclick="closePdfViewer()">Close Viewer</button>
                    <button class="button secondary" onclick="refreshPdfViewer()">Refresh</button>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h3>üßπ Cleanup</h3>
            <button class="button danger" onclick="clearAllResults()">Clear All Results</button>
            <button class="button secondary" onclick="exportDebugLog()">Export Debug Log</button>
        </div>
    </div>

    <script>
        let debugLog = [];

        // Log function to track all debug activities
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(logEntry);
            console.log(logEntry);
        }

        // Check system status
        async function checkSystemStatus() {
            log('Checking system status...');
            const resultDiv = document.getElementById('systemStatus');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box';
            resultDiv.innerHTML = 'üîç Checking system status...';

            try {
                const response = await fetch('/api/debug/file-storage');
                const result = await response.json();

                if (result.success) {
                    resultDiv.className = 'result-box success';
                    resultDiv.innerHTML = `‚úÖ System Status Check Successful

üìÅ Current Working Directory: ${result.debug_info.current_working_directory}
üìÅ App Directory: ${result.debug_info.app_directory}
üìÅ Documents Folder Exists: ${result.debug_info.documents_folder_exists ? '‚úÖ Yes' : '‚ùå No'}
üìÅ Documents Folder Path: ${result.debug_info.documents_folder_path}
üåç Environment: ${result.debug_info.environment}
üìÑ Documents Contents: ${result.debug_info.documents_folder_contents.join(', ') || 'None'}

${result.debug_info.render_info ? `üöÄ Render Info:
   Service ID: ${result.debug_info.render_info.service_id}
   Service Name: ${result.debug_info.render_info.service_name}
   Environment: ${result.debug_info.render_info.environment}` : ''}`;
                    
                    log('System status check completed successfully', 'success');
                } else {
                    resultDiv.className = 'result-box error';
                    resultDiv.innerHTML = `‚ùå System Status Check Failed: ${result.message}`;
                    log(`System status check failed: ${result.message}`, 'error');
                }
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `‚ùå Error checking system status: ${error.message}`;
                log(`Error checking system status: ${error.message}`, 'error');
            }
        }

        // Check file storage
        async function checkFileStorage() {
            log('Checking file storage...');
            const resultDiv = document.getElementById('systemStatus');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box';
            resultDiv.innerHTML = 'üîç Checking file storage...';

            try {
                // Check if documents endpoint works
                const response = await fetch('/api/documents/stored');
                const result = await response.json();

                if (result.success) {
                    resultDiv.className = 'result-box success';
                    resultDiv.innerHTML = `‚úÖ File Storage Check Successful

üìÑ Total Documents: ${result.documents.length}
üìä Document Types: ${[...new Set(result.documents.map(d => d.document_type))].join(', ')}

üìã Sample Documents:
${result.documents.slice(0, 5).map(d => `‚Ä¢ ${d.document_type}: ${d.filename} (ID: ${d.id})`).join('\n')}`;
                    
                    log(`File storage check completed. Found ${result.documents.length} documents`, 'success');
                } else {
                    resultDiv.className = 'result-box error';
                    resultDiv.innerHTML = `‚ùå File Storage Check Failed: ${result.message}`;
                    log(`File storage check failed: ${result.message}`, 'error');
                }
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `‚ùå Error checking file storage: ${error.message}`;
                log(`Error checking file storage: ${error.message}`, 'error');
            }
        }

        // Check environment
        async function checkEnvironment() {
            log('Checking environment...');
            const resultDiv = document.getElementById('systemStatus');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box';
            resultDiv.innerHTML = 'üîç Checking environment...';

            try {
                const response = await fetch('/api/debug/file-storage');
                const result = await response.json();

                if (result.success) {
                    const env = result.debug_info;
                    resultDiv.className = 'result-box info';
                    resultDiv.innerHTML = `üåç Environment Information

üè† Current Working Directory: ${env.current_working_directory}
üìÅ App Directory: ${env.app_directory}
üåç Environment: ${env.environment}
üìÅ Documents Folder: ${env.documents_folder_exists ? '‚úÖ Exists' : '‚ùå Missing'}

${env.render_info ? `üöÄ Render Deployment:
   Service: ${env.render_info.service_name}
   ID: ${env.render_info.service_id}
   Environment: ${env.render_info.environment}` : 'üè† Local Development'}

üíæ File System:
   Temp: ${env.file_system_info.temp_dir}
   Home: ${env.file_system_info.home_dir}
   User: ${env.file_system_info.user_dir}`;
                    
                    log('Environment check completed', 'info');
                } else {
                    resultDiv.className = 'result-box error';
                    resultDiv.innerHTML = `‚ùå Environment Check Failed: ${result.message}`;
                    log(`Environment check failed: ${result.message}`, 'error');
                }
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `‚ùå Error checking environment: ${error.message}`;
                log(`Error checking environment: ${error.message}`, 'error');
            }
        }

        // Test PDF generation
        async function testPdfGeneration() {
            log('Testing PDF generation...');
            const resultDiv = document.getElementById('pdfTestResults');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box';
            resultDiv.innerHTML = 'üîç Testing PDF generation...';

            try {
                // Create a simple test quote
                const testData = {
                    client_name: 'Test Client',
                    company_name: 'Test Company',
                    service_type: 'Migration Services',
                    number_of_users: 5,
                    service_tier: 'Standard',
                    total_amount: 2500
                };

                const response = await fetch('/api/generate-pdf-by-lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lookup_type: 'test',
                        lookup_value: 'test',
                        test_data: testData
                    })
                });

                if (response.ok) {
                    resultDiv.className = 'result-box success';
                    resultDiv.innerHTML = `‚úÖ PDF Generation Test Successful

üìÑ Response Status: ${response.status}
üìä Response Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`;
                    
                    log('PDF generation test completed successfully', 'success');
                } else {
                    const errorText = await response.text();
                    resultDiv.className = 'result-box error';
                    resultDiv.innerHTML = `‚ùå PDF Generation Test Failed

üìÑ Response Status: ${response.status}
‚ùå Error: ${errorText}`;
                    
                    log(`PDF generation test failed: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `‚ùå Error during PDF generation test: ${error.message}`;
                log(`Error during PDF generation test: ${error.message}`, 'error');
            }
        }

        // Test PDF preview
        async function testPdfPreview() {
            log('Testing PDF preview...');
            const resultDiv = document.getElementById('pdfTestResults');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box';
            resultDiv.innerHTML = 'üîç Testing PDF preview...';

            try {
                // First get a list of documents
                const listResponse = await fetch('/api/documents/stored');
                const listResult = await listResponse.json();

                if (listResult.success && listResult.documents.length > 0) {
                    // Test the first document
                    const testDoc = listResult.documents[0];
                    log(`Testing preview for document: ${testDoc.filename} (ID: ${testDoc.id})`);

                    const previewResponse = await fetch(`/api/documents/preview/${testDoc.id}`);
                    
                    if (previewResponse.ok) {
                        resultDiv.className = 'result-box success';
                        resultDiv.innerHTML = `‚úÖ PDF Preview Test Successful

üìÑ Document: ${testDoc.filename}
üÜî ID: ${testDoc.id}
üìä Response Status: ${previewResponse.status}
üìã Content Type: ${previewResponse.headers.get('content-type')}`;
                        
                        log('PDF preview test completed successfully', 'success');
                    } else {
                        const errorText = await previewResponse.text();
                        resultDiv.className = 'result-box error';
                        resultDiv.innerHTML = `‚ùå PDF Preview Test Failed

üìÑ Document: ${testDoc.filename}
üÜî ID: ${testDoc.id}
üìä Response Status: ${previewResponse.status}
‚ùå Error: ${errorText}`;
                        
                        log(`PDF preview test failed: ${previewResponse.status} - ${errorText}`, 'error');
                    }
                } else {
                    resultDiv.className = 'result-box warning';
                    resultDiv.innerHTML = `‚ö†Ô∏è No documents available for testing

Please generate some documents first using the "Test PDF Generation" button.`;
                    
                    log('No documents available for preview testing', 'warning');
                }
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `‚ùå Error during PDF preview test: ${error.message}`;
                log(`Error during PDF preview test: ${error.message}`, 'error');
            }
        }

        // Test PDF download
        async function testPdfDownload() {
            log('Testing PDF download...');
            const resultDiv = document.getElementById('pdfTestResults');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box';
            resultDiv.innerHTML = 'üîç Testing PDF download...';

            try {
                // First get a list of documents
                const listResponse = await fetch('/api/documents/stored');
                const listResult = await listResponse.json();

                if (listResult.success && listResult.documents.length > 0) {
                    // Test the first document
                    const testDoc = listResult.documents[0];
                    log(`Testing download for document: ${testDoc.filename} (ID: ${testDoc.id})`);

                    const downloadResponse = await fetch(`/api/documents/download/${testDoc.id}`);
                    
                    if (downloadResponse.ok) {
                        resultDiv.className = 'result-box success';
                        resultDiv.innerHTML = `‚úÖ PDF Download Test Successful

üìÑ Document: ${testDoc.filename}
üÜî ID: ${testDoc.id}
üìä Response Status: ${downloadResponse.status}
üìã Content Type: ${downloadResponse.headers.get('content-type')}
üì• Content Length: ${downloadResponse.headers.get('content-length') || 'Unknown'}`;
                        
                        log('PDF download test completed successfully', 'success');
                    } else {
                        const errorText = await downloadResponse.text();
                        resultDiv.className = 'result-box error';
                        resultDiv.innerHTML = `‚ùå PDF Download Test Failed

üìÑ Document: ${testDoc.filename}
üÜî ID: ${testDoc.id}
üìä Response Status: ${downloadResponse.status}
‚ùå Error: ${errorText}`;
                        
                        log(`PDF download test failed: ${downloadResponse.status} - ${errorText}`, 'error');
                    }
                } else {
                    resultDiv.className = 'result-box warning';
                    resultDiv.innerHTML = `‚ö†Ô∏è No documents available for testing

Please generate some documents first using the "Test PDF Generation" button.`;
                    
                    log('No documents available for download testing', 'warning');
                }
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `‚ùå Error during PDF download test: ${error.message}`;
                log(`Error during PDF download test: ${error.message}`, 'error');
            }
        }

        // Test specific document
        async function testSpecificDocument() {
            const documentId = document.getElementById('testDocumentId').value.trim();
            if (!documentId) {
                alert('Please enter a document ID to test');
                return;
            }

            log(`Testing specific document: ${documentId}`);
            const resultDiv = document.getElementById('manualTestResults');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box';
            resultDiv.innerHTML = `üîç Testing document ID: ${documentId}...`;

            try {
                // Test preview
                const previewResponse = await fetch(`/api/documents/preview/${documentId}`);
                
                if (previewResponse.ok) {
                    resultDiv.className = 'result-box success';
                    resultDiv.innerHTML = `‚úÖ Document Test Successful

üÜî Document ID: ${documentId}
üìä Preview Status: ${previewResponse.status}
üìã Content Type: ${previewResponse.headers.get('content-type')}

üéØ Next Steps:
1. Try viewing this document in the approval dashboard
2. Check if the PDF loads correctly
3. If it works here but not in dashboard, the issue is in the frontend`;

                    // Show PDF viewer
                    document.getElementById('pdfViewerContainer').style.display = 'block';
                    document.getElementById('pdfViewer').src = `/api/documents/preview/${documentId}`;
                    
                    log(`Document test completed successfully for ID: ${documentId}`, 'success');
                } else {
                    const errorText = await previewResponse.text();
                    resultDiv.className = 'result-box error';
                    resultDiv.innerHTML = `‚ùå Document Test Failed

üÜî Document ID: ${documentId}
üìä Response Status: ${previewResponse.status}
‚ùå Error: ${errorText}

üîç Troubleshooting:
1. Check if the document ID is correct
2. Verify the document exists in the database
3. Check server logs for more details`;
                    
                    log(`Document test failed for ID: ${documentId}: ${previewResponse.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `‚ùå Error testing document: ${error.message}`;
                log(`Error testing document: ${error.message}`, 'error');
            }
        }

        // Close PDF viewer
        function closePdfViewer() {
            document.getElementById('pdfViewerContainer').style.display = 'none';
            document.getElementById('pdfViewer').src = '';
        }

        // Refresh PDF viewer
        function refreshPdfViewer() {
            const pdfViewer = document.getElementById('pdfViewer');
            const currentSrc = pdfViewer.src;
            pdfViewer.src = '';
            setTimeout(() => {
                pdfViewer.src = currentSrc;
            }, 100);
        }

        // Clear all results
        function clearAllResults() {
            document.getElementById('systemStatus').style.display = 'none';
            document.getElementById('pdfTestResults').style.display = 'none';
            document.getElementById('manualTestResults').style.display = 'none';
            document.getElementById('pdfViewerContainer').style.display = 'none';
            document.getElementById('testDocumentId').value = '';
            log('All results cleared', 'info');
        }

        // Export debug log
        function exportDebugLog() {
            const logText = debugLog.join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pdf-debug-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            log('Debug log exported', 'info');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('PDF Debug Tool initialized', 'info');
        });
    </script>
</body>
</html>
