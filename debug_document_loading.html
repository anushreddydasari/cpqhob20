<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Document Loading</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 Debug Document Loading</h1>
    
    <div class="debug-section info">
        <h3>📋 Test Document Loading</h3>
        <button onclick="testDocumentLoading()">🔍 Test Document Loading</button>
        <button onclick="testAPI()">🌐 Test API Directly</button>
        <button onclick="clearResults()">🗑️ Clear Results</button>
    </div>
    
    <div class="debug-section">
        <h3>📊 Results</h3>
        <div id="results"></div>
    </div>
    
    <div class="debug-section">
        <h3>📄 Document Display Test</h3>
        <button onclick="testDocumentDisplay()">📋 Test Document Display</button>
        <div id="documentDisplay"></div>
    </div>

    <script>
        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.createElement('div');
            resultDiv.className = `debug-section ${type}`;
            resultDiv.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('documentDisplay').innerHTML = '';
        }

        async function testAPI() {
            showResult('🌐 Testing API directly...', 'info');
            
            try {
                const response = await fetch('/api/documents/stored');
                const result = await response.json();
                
                if (result.success) {
                    showResult(`✅ API Success! Found ${result.count} documents`, 'success');
                    showResult(`📄 Documents: ${JSON.stringify(result.documents, null, 2)}`, 'info');
                } else {
                    showResult(`❌ API Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult(`❌ Fetch Error: ${error.message}`, 'error');
            }
        }

        async function testDocumentLoading() {
            showResult('📋 Testing document loading function...', 'info');
            
            try {
                const response = await fetch('/api/documents/stored');
                const result = await response.json();
                
                if (result.success && result.documents.length > 0) {
                    showResult(`✅ Successfully loaded ${result.documents.length} documents`, 'success');
                    
                    // Test the same logic as the main page
                    const documents = result.documents;
                    let tableHTML = `
                        <h4>📄 Document Table Test:</h4>
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                            <thead>
                                <tr style="background: #2196f3; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">📄 Document</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">👤 Client</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">🏢 Company</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">📅 Generated</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">📎 Attach</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    documents.forEach(doc => {
                        tableHTML += `
                            <tr style="background: #f8f9fa;">
                                <td style="padding: 8px; border: 1px solid #ddd;">
                                    <strong>${doc.document_type}</strong><br>
                                    <small style="color: #666;">${doc.filename}</small>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${doc.client_name}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${doc.company_name}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${new Date(doc.generated_at).toLocaleDateString()}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">
                                    <input type="checkbox" id="attach_${doc.id}" value="${doc.id}" style="transform: scale(1.2);">
                                    <label for="attach_${doc.id}" style="margin-left: 5px; font-size: 0.8rem;">Attach</label>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += `
                            </tbody>
                        </table>
                    `;
                    
                    showResult('✅ Document table generated successfully', 'success');
                    showResult(tableHTML, 'info');
                } else {
                    showResult('❌ No documents found or API error', 'error');
                }
            } catch (error) {
                showResult(`❌ Error: ${error.message}`, 'error');
            }
        }

        async function testDocumentDisplay() {
            showResult('📄 Testing document display...', 'info');
            
            try {
                const response = await fetch('/api/documents/stored');
                const result = await response.json();
                
                if (result.success && result.documents.length > 0) {
                    const displayDiv = document.getElementById('documentDisplay');
                    
                    let displayHTML = '<h4>📋 Available Documents:</h4>';
                    result.documents.forEach((doc, index) => {
                        displayHTML += `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <strong>${index + 1}. ${doc.document_type}</strong><br>
                                <strong>Filename:</strong> ${doc.filename}<br>
                                <strong>Client:</strong> ${doc.client_name}<br>
                                <strong>Company:</strong> ${doc.company_name}<br>
                                <strong>Generated:</strong> ${new Date(doc.generated_at).toLocaleString()}<br>
                                <strong>ID:</strong> ${doc.id}
                            </div>
                        `;
                    });
                    
                    displayDiv.innerHTML = displayHTML;
                    showResult(`✅ Displayed ${result.documents.length} documents`, 'success');
                } else {
                    showResult('❌ No documents to display', 'error');
                }
            } catch (error) {
                showResult(`❌ Display Error: ${error.message}`, 'error');
            }
        }

        // Auto-test on page load
        window.onload = function() {
            showResult('🚀 Debug page loaded. Click buttons to test functionality.', 'info');
        };
    </script>
</body>
</html>
