<!DOCTYPE html>
<html>
<head>
  <title>Professional Quote - CPQ System</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background-color: #f5f5f5;
    }
    
    .quote-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #007BFF, #0056b3);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 300;
    }
    
    .header p {
      margin: 10px 0 0 0;
      opacity: 0.9;
      font-size: 16px;
    }
    
    .quote-info {
      padding: 30px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .quote-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .client-info, .quote-meta {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 6px;
    }
    
    .client-info h3, .quote-meta h3 {
      margin: 0 0 15px 0;
      color: #007BFF;
      font-size: 18px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 5px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .info-label {
      font-weight: 600;
      color: #495057;
    }
    
    .info-value {
      color: #212529;
    }
    
    .pricing-section {
      padding: 30px;
    }
    
    .pricing-section h2 {
      color: #007BFF;
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
    }
    
    .pricing-table, .service-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .pricing-table th, .service-table th {
      background: #007BFF;
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 600;
    }
    
    .pricing-table td, .service-table td {
      padding: 12px 15px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
    }
    
    .service-table td {
      text-align: left;
    }
    
    .service-table td:last-child {
      text-align: right;
    }
    
    .pricing-table tr:nth-child(even), .service-table tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    .total-row {
      background: #e3f2fd !important;
      font-weight: bold;
      font-size: 18px;
    }
    
    .total-row td {
      color: #007BFF;
    }
    
    .service-table .total-row {
      background: #28a745 !important;
    }
    
    .service-table .total-row td {
      color: white;
    }
    
    .terms-section {
      padding: 30px;
      background: #f8f9fa;
    }
    
    .terms-section h3 {
      color: #007BFF;
      margin-bottom: 15px;
    }
    
    .terms-list {
      list-style: none;
      padding: 0;
    }
    
    .terms-list li {
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .terms-list li:before {
      content: "‚Ä¢";
      color: #007BFF;
      font-weight: bold;
      margin-right: 10px;
    }
    
    .footer {
      padding: 30px;
      text-align: center;
      background: #343a40;
      color: white;
    }
    
    .footer h4 {
      margin: 0 0 15px 0;
      color: #007BFF;
    }
    
    .contact-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .download-section {
      text-align: center;
      padding: 30px;
      background: #e9ecef;
    }
    
    .download-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .download-btn:hover {
      background: #218838;
    }
    
    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 15px;
      transition: background 0.3s;
    }
    
    .back-btn:hover {
      background: #545b62;
    }
    
    @media print {
      .download-section, .back-btn {
        display: none;
      }
      body { background: white; }
      .quote-container { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="quote-container">
    <!-- Header -->
    <div class="header">
      <h1>PROFESSIONAL QUOTE</h1>
      <p>Migration Services & Solutions</p>
    </div>
    
    <!-- Quote Information -->
    <div class="quote-info">
      <div class="quote-details">
        <div class="client-info">
          <h3>Client Information</h3>
          <div class="info-row">
            <span class="info-label">Name:</span>
            <span class="info-value" id="clientName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Company:</span>
            <span class="info-value" id="companyName">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Email:</span>
            <span class="info-value" id="clientEmail">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Phone:</span>
            <span class="info-value" id="clientPhone">-</span>
          </div>
        </div>
        
        <div class="quote-meta">
          <h3>Quote Details</h3>
          <div class="info-row">
            <span class="info-label">Quote Date:</span>
            <span class="info-value" id="quoteDate">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Service Type:</span>
            <span class="info-value" id="serviceType">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Migration Type:</span>
            <span class="info-value" id="migrationType">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Project Duration:</span>
            <span class="info-value" id="projectDuration">-</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Pricing Section -->
    <div class="pricing-section">
      <h2>Pricing Breakdown</h2>
      <table class="pricing-table">
        <thead>
          <tr>
            <th>Service Details</th>
            <th>Basic Plan</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Per User Cost</strong></td>
            <td id="basicPerUser">$0.00</td>
          </tr>
          <tr>
            <td><strong>Per GB Cost</strong></td>
            <td id="basicPerGB">$0.00</td>
          </tr>
          <tr>
            <td><strong>Total User Cost</strong></td>
            <td id="basicUserTotal">$0.00</td>
          </tr>
          <tr>
            <td><strong>Data Cost</strong></td>
            <td id="basicDataCost">$0.00</td>
          </tr>
          <tr>
            <td><strong>Migration Cost</strong></td>
            <td id="basicMigration">$0.00</td>
          </tr>
          <tr>
            <td><strong>Instance Cost</strong></td>
            <td id="basicInstance">$0.00</td>
          </tr>
          <tr class="total-row">
            <td><strong>TOTAL COST</strong></td>
            <td id="basicTotal">$0.00</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Service Details Section -->
    <div class="pricing-section">
      <h2>Service Details</h2>
      <table class="service-table">
        <thead>
          <tr>
            <th>Job</th>
            <th>Description</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>CloudFuze X-Change Data Migration</strong></td>
            <td id="migrationDescription">slack to teams {Up to <span id="userCount">0</span> users}</td>
            <td id="migrationTotalPrice">$<span id="calculatedTotal">0.00</span></td>
          </tr>
          <tr>
            <td><strong>Managed Migration Service</strong></td>
            <td id="managedServiceDescription">Fully Managed Migration | Dedicated Project Manager Valid for <span id="durationMonths">0</span> months</td>
            <td id="managedServicePrice">$<span id="migrationCostOnly">0.00</span></td>
          </tr>
          <tr class="total-row">
            <td><strong>Total</strong></td>
            <td>Total Amount</td>
            <td id="finalTotalAmount">$<span id="totalAmount">0.00</span></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Signature Section -->
    <div class="terms-section">
      <h3>Signatures</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <div style="margin-bottom: 8px; color: #495057; font-weight: 600;">Client Signature</div>
          <div id="clientSignatureBox" style="height: 120px; border: 2px dashed #ced4da; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: #fff;">
            <span style="color:#6c757d">Click to sign</span>
          </div>
        </div>
        <div>
          <div style="margin-bottom: 8px; color: #495057; font-weight: 600;">Company Manager Signature</div>
          <div id="managerSignatureBox" style="height: 120px; border: 2px dashed #ced4da; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: #fff;">
            <span style="color:#6c757d">Click to sign</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Terms Section -->
    <div class="terms-section">
      <h3>Terms & Conditions</h3>
      <ul class="terms-list">
        <li>This quote is valid for 30 days from the date of issue</li>
        <li>Payment terms: 50% upfront, 50% upon completion</li>
        <li>Project timeline will be finalized upon acceptance</li>
        <li>Any changes to scope may affect pricing</li>
        <li>Support and maintenance included for 3 months post-migration</li>
      </ul>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <h4>Contact Information</h4>
      <div class="contact-info">
        <div>
          <strong>Email:</strong><br>
          sales@yourcompany.com
        </div>
        <div>
          <strong>Phone:</strong><br>
          +1 (555) 123-4567
        </div>
        <div>
          <strong>Website:</strong><br>
          www.yourcompany.com
        </div>
      </div>
    </div>
  </div>
  
  <!-- Download Section -->
  <div class="download-section">
    <button class="back-btn" onclick="goBack()">Back to Calculator</button>
    <button class="back-btn" onclick="refreshData()" style="background-color: #17a2b8;">Refresh Data</button>
    <button class="back-btn" onclick="testDataPopulation()" style="background-color: #ffc107; color: #000;">Test Data</button>
    <button class="back-btn" onclick="testPlaceholders()" style="background-color: #28a745; color: white;">Test Placeholders</button>
    <button class="back-btn" onclick="testPDFGeneration()" style="background-color: #6f42c1; color: white;">Test PDF</button>
    <button class="download-btn" onclick="downloadPDF()">Generate Agreement PDF</button>
  </div>

  <!-- Debug Information (remove in production) -->
  <div style="background: #f8f9fa; padding: 20px; margin: 20px; border-radius: 5px; font-family: monospace; font-size: 12px;">
    <h4>Debug Information:</h4>
    <div id="debugInfo">Loading...</div>
    <hr>
    <h5>Template Status:</h5>
    <div id="templateStatus">Not populated</div>
  </div>

  <!-- Include html2pdf library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <script>
    // Signature Modal
    const signatureModal = document.createElement('div');
    signatureModal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000;';
    signatureModal.innerHTML = `
      <div style="background:#fff; width:720px; max-width:95vw; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
        <div style="padding:16px 20px; border-bottom:1px solid #e9ecef; display:flex; align-items:center; justify-content:space-between;">
          <div style="font-weight:600; color:#343a40">Add Signature</div>
          <button id="sigCloseBtn" style="background:#dc3545; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer">Close</button>
        </div>
        <div style="padding:16px 20px;">
          <div style="display:flex; gap:12px; margin-bottom:12px;">
            <button id="sigModeDraw" class="sig-mode">‚úçÔ∏è Draw</button>
            <button id="sigModeType" class="sig-mode">‚å®Ô∏è Type</button>
            <button id="sigClear" style="margin-left:auto" class="sig-mode">üßπ Clear</button>
          </div>
          <div id="sigDrawArea" style="display:block;">
            <canvas id="sigCanvas" width="660" height="200" style="border:2px solid #e9ecef; border-radius:6px; width:100%"></canvas>
          </div>
          <div id="sigTypeArea" style="display:none;">
            <input id="sigTypeInput" placeholder="Type your name" style="width:100%; padding:12px; border:2px solid #e9ecef; border-radius:6px; font-size:20px;">
            <div style="margin-top:10px; color:#6c757d">Your signature will be rendered in a cursive font.</div>
          </div>
          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
            <button id="sigSaveBtn" style="background:#28a745; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer">Save</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(signatureModal);

    function styleSigModeButtons() {
      document.querySelectorAll('.sig-mode').forEach(btn => {
        btn.style.background = '#667eea';
        btn.style.color = '#fff';
        btn.style.border = 'none';
        btn.style.padding = '8px 12px';
        btn.style.borderRadius = '6px';
        btn.style.cursor = 'pointer';
      });
    }
    styleSigModeButtons();

    let sigContext, isDrawing = false, sigTargetRole = 'client';
    const canvas = () => document.getElementById('sigCanvas');
    const ctx = () => canvas().getContext('2d');

    function openSignature(role) {
      sigTargetRole = role;
      signatureModal.style.display = 'flex';
      setTimeout(() => { resizeCanvas(); }, 0);
    }
    function closeSignature() { signatureModal.style.display = 'none'; }

    function resizeCanvas() {
      const c = canvas();
      const parentWidth = c.parentElement.clientWidth;
      const ratio = c.height / c.width;
      c.width = parentWidth - 4;
      c.height = Math.max(160, c.width * ratio);
    }
    window.addEventListener('resize', resizeCanvas);

    function initDrawEvents() {
      const c = canvas(); const context = ctx(); context.lineWidth = 2.5; context.lineCap = 'round';
      const getPos = (e) => {
        const rect = c.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      };
      const start = (e) => { isDrawing = true; const p = getPos(e); context.beginPath(); context.moveTo(p.x, p.y); };
      const move = (e) => { if (!isDrawing) return; const p = getPos(e); context.lineTo(p.x, p.y); context.stroke(); };
      const end = () => { isDrawing = false; };
      c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
      c.addEventListener('touchstart', start, { passive: true }); c.addEventListener('touchmove', move, { passive: true }); window.addEventListener('touchend', end);
    }
    initDrawEvents();

    function clearCanvas() { const c = canvas(); ctx().clearRect(0, 0, c.width, c.height); }

    document.getElementById('sigModeDraw').onclick = () => {
      document.getElementById('sigDrawArea').style.display = 'block';
      document.getElementById('sigTypeArea').style.display = 'none';
    };
    document.getElementById('sigModeType').onclick = () => {
      document.getElementById('sigDrawArea').style.display = 'none';
      document.getElementById('sigTypeArea').style.display = 'block';
    };
    document.getElementById('sigClear').onclick = clearCanvas;
    document.getElementById('sigCloseBtn').onclick = closeSignature;

    async function saveSignatureDataUrl(dataUrl) {
      const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
      const payload = {
        role: sigTargetRole,
        name: sigTargetRole === 'client' ? clientData.clientName : 'Company Manager',
        email: sigTargetRole === 'client' ? clientData.email : 'manager@yourcompany.com',
        company: sigTargetRole === 'client' ? clientData.companyName : 'Your Company LLC',
        signature_data: dataUrl
      };
      const resp = await fetch('/api/signatures', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const result = await resp.json();
      if (!resp.ok || !result.success) throw new Error(result.message || 'Failed to save signature');
      return result.signature_id;
    }

    function placeSignaturePreview(role, dataUrl) {
      const box = role === 'client' ? document.getElementById('clientSignatureBox') : document.getElementById('managerSignatureBox');
      box.innerHTML = `<img src="${dataUrl}" alt="signature" style="max-height:110px; max-width:100%; object-fit:contain;">`;
    }

    document.getElementById('sigSaveBtn').onclick = async () => {
      try {
        const drawActive = document.getElementById('sigDrawArea').style.display !== 'none';
        let dataUrl;
        if (drawActive) {
          dataUrl = canvas().toDataURL('image/png');
        } else {
          const name = document.getElementById('sigTypeInput').value.trim();
          if (!name) { alert('Please type your name'); return; }
          // Render typed signature on canvas for consistent image output
          clearCanvas();
          const c = canvas(); const context = ctx(); context.fillStyle = '#000'; context.font = '48px "Brush Script MT", "Lucida Handwriting", cursive';
          context.fillText(name, 24, c.height / 1.8);
          dataUrl = c.toDataURL('image/png');
        }
        await saveSignatureDataUrl(dataUrl);
        placeSignaturePreview(sigTargetRole, dataUrl);
        closeSignature();
      } catch (err) {
        alert('Failed to save signature: ' + err.message);
      }
    };

    // Open signature modal on click boxes
    document.getElementById('clientSignatureBox').onclick = () => openSignature('client');
    document.getElementById('managerSignatureBox').onclick = () => openSignature('manager');
    // Load quote data from localStorage
    window.onload = function() {
      const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
      const quoteData = JSON.parse(localStorage.getItem('quoteData') || '{}');
      
      // Show debug information
      document.getElementById('debugInfo').textContent = `Client Data: ${JSON.stringify(clientData)}\nQuote Data: ${JSON.stringify(quoteData)}`;
      
      if (Object.keys(clientData).length === 0) {
        // No client data, redirect back
        console.error('No client data found, redirecting...');
        window.location.href = '/';
        return;
      }
      
      if (!quoteData.quote) {
        console.error('No quote data found');
        document.querySelector('.download-btn').textContent = 'No Quote Data Available';
        document.querySelector('.download-btn').disabled = true;
        return;
      }
      
      // Populate template with data
      populateTemplate();
      loadLatestSignatures();
    };
    
    // Enhanced populate template function
    function populateTemplate() {
      const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
      const quoteData = JSON.parse(localStorage.getItem('quoteData') || '{}');
      
      // Debug logging
      console.log('Client Data:', clientData);
      console.log('Quote Data:', quoteData);
      
      // Check if we have the minimum required data
      if (Object.keys(clientData).length === 0) {
        console.error('No client data found');
        document.querySelector('.download-btn').textContent = 'No Client Data Available';
        document.querySelector('.download-btn').disabled = true;
        document.getElementById('templateStatus').textContent = '‚ùå No client data available';
        return;
      }
      
      if (!quoteData.quote) {
        console.error('No quote data found');
        document.querySelector('.download-btn').textContent = 'No Quote Data Available';
        document.querySelector('.download-btn').disabled = true;
        document.getElementById('templateStatus').textContent = '‚ùå No quote data available';
        return;
      }
      
      // Populate client information
      document.getElementById('clientName').textContent = clientData.clientName || 'N/A';
      document.getElementById('companyName').textContent = clientData.companyName || 'N/A';
      document.getElementById('clientEmail').textContent = clientData.email || 'N/A';
      document.getElementById('clientPhone').textContent = clientData.phoneNumber || 'N/A';
      
      // Populate quote details
      document.getElementById('quoteDate').textContent = new Date().toLocaleDateString();
      document.getElementById('serviceType').textContent = clientData.serviceType || 'N/A';
      document.getElementById('migrationType').textContent = quoteData.migrationType || 'N/A';
      document.getElementById('projectDuration').textContent = (quoteData.duration || 0) + ' months';
      
      // Populate pricing
      populatePricing(quoteData.quote);
      
      // Enable download button after successful data population
      document.querySelector('.download-btn').disabled = false;
      document.querySelector('.download-btn').textContent = 'Generate Agreement PDF';
      document.getElementById('templateStatus').textContent = '‚úÖ Template populated successfully - Ready for PDF generation';
      
      console.log('Template populated successfully');
    }
    
    // Populate pricing table
    function populatePricing(quote) {
      // Get the selected plan or default to basic
      const selectedPlan = localStorage.getItem('selectedPlan') || 'basic';
      const planData = quote[selectedPlan] || quote.basic;
      
      if (planData) {
        // Populate basic pricing table
        document.getElementById('basicPerUser').textContent = '$' + planData.perUserCost.toFixed(2);
        document.getElementById('basicPerGB').textContent = '$' + planData.perGBCost.toFixed(2);
        document.getElementById('basicUserTotal').textContent = '$' + planData.totalUserCost.toFixed(2);
        document.getElementById('basicDataCost').textContent = '$' + planData.dataCost.toFixed(2);
        document.getElementById('basicMigration').textContent = '$' + planData.migrationCost.toFixed(2);
        document.getElementById('basicInstance').textContent = '$' + planData.instanceCost.toFixed(2);
        document.getElementById('basicTotal').textContent = '$' + planData.totalCost.toFixed(2);
        
        // Populate service details placeholders
        populateServiceDetails(planData);
      }
      
      // Enable download button after data is populated
      document.querySelector('.download-btn').disabled = false;
      document.querySelector('.download-btn').textContent = 'Generate Agreement PDF';
    }
    
    // Populate service details placeholders
    function populateServiceDetails(planData) {
      // Get additional data from localStorage
      const quoteData = JSON.parse(localStorage.getItem('quoteData') || '{}');
      const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
      
      // Populate user count
      const userCount = quoteData.users || 0;
      document.getElementById('userCount').textContent = userCount;
      
      // Populate duration in months
      const durationMonths = quoteData.duration || 0;
      document.getElementById('durationMonths').textContent = durationMonths;
      
      // Populate migration cost
      document.getElementById('migrationCost').textContent = planData.migrationCost.toFixed(2);
      document.getElementById('migrationCostOnly').textContent = planData.migrationCost.toFixed(2);
      
      // Populate instance cost
      document.getElementById('instanceCost').textContent = planData.instanceCost.toFixed(2);
      
      // Calculate and populate total amount
      const totalAmount = planData.totalCost;
      document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
      
      // Update migration description with actual migration type
      const migrationType = quoteData.migrationType || 'Standard';
      const migrationDescription = `slack to teams {Up to ${userCount} users}`;
      document.getElementById('migrationDescription').innerHTML = migrationDescription;
      
      // Update managed service description
      const managedServiceDescription = `Fully Managed Migration | Dedicated Project Manager Valid for ${durationMonths} months`;
      document.getElementById('managedServiceDescription').innerHTML = managedServiceDescription;
      
      // Update price displays with actual values
      const calculatedTotal = planData.migrationCost + planData.instanceCost;
      document.getElementById('calculatedTotal').textContent = calculatedTotal.toFixed(2);
      document.getElementById('migrationCostOnly').textContent = planData.migrationCost.toFixed(2);
      document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
    }

    // Embed signatures into PDF by drawing them into the DOM (already previewed) so html2pdf picks them up.
    // Optionally pull latest client signature by email on load.
    async function loadLatestSignatures() {
      try {
        const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
        if (clientData.email) {
          const resp = await fetch(`/api/signatures/latest?role=client&email=${encodeURIComponent(clientData.email)}`);
          const result = await resp.json();
          if (result.success && result.signature && result.signature.signature_data) {
            placeSignaturePreview('client', result.signature.signature_data);
          }
        }
      } catch (e) { /* non-blocking */ }
    }
    
    // Generate Agreement PDF function
    async function downloadPDF() {
      try {
        // First, ensure data is populated
        populateTemplate();
        
        // Check if data is available
        const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
        const quoteData = JSON.parse(localStorage.getItem('quoteData') || '{}');
        
        if (Object.keys(clientData).length === 0 || !quoteData.quote) {
          alert('No data available for PDF generation. Please generate a quote first.');
          return;
        }
        
        // Show loading message
        document.querySelector('.download-btn').textContent = 'Generating Agreement PDF...';
        document.querySelector('.download-btn').disabled = true;
        
        // Get the selected plan
        const selectedPlan = localStorage.getItem('selectedPlan') || 'standard';
        
        // Get quote ID from URL or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const quoteId = urlParams.get('quoteId') || localStorage.getItem('currentQuoteId');
        
        if (!quoteId) {
          alert('Quote ID not found. Please generate a quote first.');
          document.querySelector('.download-btn').textContent = 'Generate Agreement PDF';
          document.querySelector('.download-btn').disabled = false;
          return;
        }
        
        // Update the stored plan for this quote
        try {
          await fetch(`/api/quotes/${quoteId}/selected-plan`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ selectedPlan: selectedPlan })
          });
        } catch (e) {
          console.log('Could not update stored plan:', e);
        }
        
        // Generate Purchase Agreement PDF
        const response = await fetch('/api/generate-pdf-by-lookup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lookup_type: 'quoteId',
            lookup_value: quoteId,
            template_id: 'new_document_1757400255209_6vn909', // Default template ID
            selected_plan: selectedPlan
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to generate agreement PDF');
        }
        
        // Download the PDF
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `agreement_${clientData.clientName || 'client'}_${selectedPlan}_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Success - Reset button
        document.querySelector('.download-btn').textContent = 'Generate Agreement PDF';
        document.querySelector('.download-btn').disabled = false;
        console.log('Agreement PDF generated successfully');
        
      } catch (error) {
        console.error('Error in downloadPDF function:', error);
        alert('Error generating agreement PDF: ' + error.message);
        document.querySelector('.download-btn').textContent = 'Generate Agreement PDF';
        document.querySelector('.download-btn').disabled = false;
      }
    }
    
    // Go back function
    function goBack() {
      window.location.href = '/quote-calculator';
    }

    // Function to refresh data from localStorage
    function refreshData() {
      const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
      const quoteData = JSON.parse(localStorage.getItem('quoteData') || '{}');

      document.getElementById('debugInfo').textContent = `Client Data: ${JSON.stringify(clientData)}\nQuote Data: ${JSON.stringify(quoteData)}`;
      console.log('Refreshing data...');
      populateTemplate(); // Re-populate template to update values
    }

    // Function to test data population
    function testDataPopulation() {
      const clientData = {
        clientName: 'Test Client',
        companyName: 'Test Company',
        email: 'test@example.com',
        phoneNumber: '123-456-7890',
        serviceType: 'Migration',
        duration: 6
      };

      const quoteData = {
        quote: {
          basic: {
            perUserCost: 10.50,
            perGBCost: 0.50,
            totalUserCost: 100.00,
            dataCost: 500.00,
            migrationCost: 200.00,
            instanceCost: 100.00,
            totalCost: 450.00
          },
          standard: {
            perUserCost: 15.00,
            perGBCost: 0.75,
            totalUserCost: 150.00,
            dataCost: 750.00,
            migrationCost: 300.00,
            instanceCost: 150.00,
            totalCost: 700.00
          },
          advanced: {
            perUserCost: 20.00,
            perGBCost: 1.00,
            totalUserCost: 200.00,
            dataCost: 1000.00,
            migrationCost: 400.00,
            instanceCost: 200.00,
            totalCost: 900.00
          }
        },
        migrationType: 'Full',
        duration: 6
      };

      localStorage.setItem('clientData', JSON.stringify(clientData));
      localStorage.setItem('quoteData', JSON.stringify(quoteData));

      document.getElementById('debugInfo').textContent = `Client Data: ${JSON.stringify(clientData)}\nQuote Data: ${JSON.stringify(quoteData)}`;
      document.getElementById('templateStatus').textContent = 'Populated with test data';
      console.log('Test data populated successfully');
      populateTemplate(); // Re-populate to show test data in template
    }

    // Function to test placeholders with sample data
    function testPlaceholders() {
      try {
        console.log('Testing placeholders with sample data...');
        
        // Create sample quote data
        const sampleQuoteData = {
          basic: {
            perUserCost: 30.00,
            perGBCost: 1.00,
            totalUserCost: 300.00,
            dataCost: 500.00,
            migrationCost: 300.00,
            instanceCost: 12000.00,
            totalCost: 13100.00
          }
        };
        
        const sampleConfigData = {
          users: 10,
          duration: 6,
          migrationType: 'Standard',
          dataSize: 500
        };
        
        // Store sample data in localStorage
        localStorage.setItem('quoteData', JSON.stringify(sampleConfigData));
        localStorage.setItem('selectedPlan', 'basic');
        
        // Create sample client data
        const sampleClientData = {
          clientName: 'Test Client',
          companyName: 'Test Company',
          email: 'test@example.com',
          phoneNumber: '123-456-7890',
          serviceType: 'Migration Services'
        };
        localStorage.setItem('clientData', JSON.stringify(sampleClientData));
        
        // Update the quote data with sample data
        const updatedQuoteData = { ...sampleConfigData, quote: sampleQuoteData };
        localStorage.setItem('quoteData', JSON.stringify(updatedQuoteData));
        
        // Populate the template
        populateTemplate();
        
        // Show success message
        alert('‚úÖ Placeholders populated with test data! Check the template to see the populated values.');
        
        // Update debug info
        document.getElementById('debugInfo').textContent = `Test Data Loaded:\nClient: ${JSON.stringify(sampleClientData)}\nQuote: ${JSON.stringify(updatedQuoteData)}`;
        document.getElementById('templateStatus').textContent = '‚úÖ Test data loaded - Placeholders populated';
        
      } catch (error) {
        console.error('Error testing placeholders:', error);
        alert('‚ùå Error testing placeholders: ' + error.message);
      }
    }

    // Function to test PDF generation with simple content
    function testPDFGeneration() {
      try {
        const testElement = document.createElement('div');
        testElement.innerHTML = '<h1>Test PDF</h1><p>This is a test PDF to verify html2pdf is working.</p>';
        testElement.style.padding = '20px';
        testElement.style.fontSize = '16px';
        
        const opt = {
          margin: 1,
          filename: 'test.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        
        html2pdf().set(opt).from(testElement).save().then(() => {
          alert('Test PDF generated successfully! html2pdf is working.');
        }).catch((error) => {
          alert('Test PDF failed: ' + error.message);
        });
        
      } catch (error) {
        alert('Test PDF error: ' + error.message);
      }
    }
  </script>
</body>
</html>
