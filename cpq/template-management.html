<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agreement Template Generator</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; background: #f5f6f8; font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif; color: #333; }
    .container { max-width: 900px; margin: 40px auto; padding: 20px; }
    .card { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 8px 0; }
    .muted { color: #6b7280; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; }
    .label { display: block; font-weight: 600; margin-bottom: 6px; }
    .input, .select { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; }
    .input:focus, .select:focus { outline: none; border-color: #667eea; }
    .btn { background: #0ea5e9; color: #fff; border: none; padding: 12px 18px; border-radius: 8px; cursor: pointer; font-size: 0.95rem; }
    .btn:hover { background: #0284c7; }
    .status { margin-top: 14px; padding: 10px; border-radius: 8px; font-weight: 500; }
    .status.info { background: #e0f2fe; color: #075985; }
    .status.success { background: #dcfce7; color: #14532d; }
    .status.error { background: #fee2e2; color: #7f1d1d; }
    .preview { margin-top: 16px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 14px; max-height: 380px; overflow-y: auto; white-space: pre-wrap; font-family: "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Agreement Generator</h1>
      <div class="muted">Lookup by Quote ID, Username, or Email and generate the agreement.</div>

      <div id="agreementHeader" style="display:none; margin:10px 0 12px 0;">
        <div style="background:#ffffff; border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <img id="logoLeft" alt="Left Logo" style="height:42px; max-width:48%; object-fit:contain;" />
            <img id="logoRight" alt="Right Logo" style="height:42px; max-width:48%; object-fit:contain;" />
          </div>
          <h2 id="agreementTitle" style="margin:0 0 8px 0; font-size:1.1rem; color:#111827;">Purchase Agreement</h2>
          <p id="agreementSubtitle" style="margin:0 0 10px 0; color:#374151; font-size:0.95rem;"></p>
          <div id="agreementBanner" style="margin-top:10px; background:#cfe8f6; border:1px solid #99c7e3; padding:10px 12px; font-weight:700; color:#1f2937; border-radius:4px; text-align:center;">
            Cloud-Hosted SaaS Solution | Managed Migration | Dedicated Migration Manager
          </div>
        </div>
      </div>

      <div id="pricingTable" style="display:none; margin:18px 0 8px 0;">
        <table style="width:100%; border-collapse:collapse; font-size:0.95rem; background:#fff;">
          <thead>
            <tr>
              <th style="text-align:left; border:1px solid #e5e7eb; padding:10px; background:#e6f0f8;">Job Requirement</th>
              <th style="text-align:left; border:1px solid #e5e7eb; padding:10px; background:#e6f0f8;">Description</th>
              <th style="text-align:left; border:1px solid #e5e7eb; padding:10px; background:#e6f0f8;">Migration Type</th>
              <th style="text-align:right; border:1px solid #e5e7eb; padding:10px; background:#e6f0f8;">Price (USD)</th>
            </tr>
          </thead>
          <tbody id="pricingRows"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="text-align:right; border:1px solid #e5e7eb; padding:10px; font-weight:700;">Total Price</td>
              <td id="pricingTotal" style="text-align:right; border:1px solid #e5e7eb; padding:10px; font-weight:700;">$0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="grid">
        <div>
          <label class="label">Lookup By</label>
          <select id="lookupType" class="select" onchange="toggleLookupFields()">
            <option value="quoteId">Quote ID</option>
            <option value="username">Username</option>
            <option value="email">Email</option>
          </select>
        </div>

        <div id="quoteIdGroup">
          <label class="label">Quote ID</label>
          <input id="quoteId" class="input" placeholder="Enter full ID or first 8 chars">
        </div>

        <div id="usernameGroup" style="display:none;">
          <label class="label">Username</label>
          <input id="username" class="input" placeholder="Enter client name">
        </div>

        <div id="emailGroup" style="display:none;">
          <label class="label">Email</label>
          <input id="email" class="input" placeholder="Enter client email">
        </div>
      </div>

      <div style="margin-top:12px;">
        <button class="btn" onclick="handleGenerate()">Generate Agreement</button>
      </div>

      <div id="status" class="status info" style="display:none;"></div>
      <div id="preview" class="preview" style="display:none;"></div>
    </div>
  </div>

  <script>
    function toggleLookupFields() {
      const t = document.getElementById('lookupType').value;
      document.getElementById('quoteIdGroup').style.display = (t === 'quoteId') ? 'block' : 'none';
      document.getElementById('usernameGroup').style.display = (t === 'username') ? 'block' : 'none';
      document.getElementById('emailGroup').style.display = (t === 'email') ? 'block' : 'none';
    }

    function showStatus(msg, type='info') {
      const el = document.getElementById('status');
      el.textContent = msg; el.className = 'status ' + type; el.style.display = 'block';
    }

    function showPreview(text) {
      const el = document.getElementById('preview'); el.textContent = text || ''; el.style.display = text ? 'block' : 'none';
    }

    function renderPricingTable(pricing) {
      try {
        if (!pricing || !Array.isArray(pricing.rows)) { document.getElementById('pricingTable').style.display = 'none'; return; }
        const rowsEl = document.getElementById('pricingRows');
        rowsEl.innerHTML = '';
        pricing.rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style=\"border:1px solid #e5e7eb; padding:10px;\">${r.job_requirement || ''}</td>
            <td style=\"border:1px solid #e5e7eb; padding:10px;\">${r.description || ''}</td>
            <td style=\"border:1px solid #e5e7eb; padding:10px;\">${r.migration_type || ''}</td>
            <td style=\"border:1px solid #e5e7eb; padding:10px; text-align:right;\">$${Number(r.price_usd || 0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          `;
          rowsEl.appendChild(tr);
        });
        document.getElementById('pricingTotal').textContent = `$${Number(pricing.total_price || 0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`;
        document.getElementById('pricingTable').style.display = 'block';
      } catch (e) {
        document.getElementById('pricingTable').style.display = 'none';
      }
    }

    function renderHeader(templateData) {
      try {
        const headerEl = document.getElementById('agreementHeader');
        const titleEl = document.getElementById('agreementTitle');
        const subtitleEl = document.getElementById('agreementSubtitle');
        const logoLeft = document.getElementById('logoLeft');
        const logoRight = document.getElementById('logoRight');

        const company = (templateData && (templateData.client_company || templateData.company_name)) || 'Client';
        titleEl.textContent = `CloudFuze Purchase Agreement for ${company}.`;
        subtitleEl.textContent = `${company} is provided pricing for use of the CloudFuze X-Change Enterprise Data Migration Solution:`;
        // Set logos (use hosted URLs or data URLs; these are placeholders you can replace)
        logoLeft.src = 'https://dummyimage.com/160x42/ffffff/0f4cbd.png&text=CloudFuze';
        logoRight.src = 'https://dummyimage.com/160x42/ffffff/111111.png&text=Microsoft+Partner';

        headerEl.style.display = 'block';
      } catch (e) {
        document.getElementById('agreementHeader').style.display = 'none';
      }
    }

    async function resolveQuoteId(lookupType, value) {
      if (lookupType === 'quoteId') return value.trim();
      const res = await fetch('/api/quotes/list');
      const data = await res.json();
      if (!data.success) throw new Error('Failed to load quotes');
      const quotes = data.quotes || []; const v = value.trim().toLowerCase();
      if (lookupType === 'username') { const m = quotes.find(q => (q.client_name || '').toLowerCase().includes(v)); return m ? m.id : null; }
      if (lookupType === 'email') { const m = quotes.find(q => (q.client_email || '').toLowerCase().includes(v)); return m ? m.id : null; }
      return null;
    }

    async function handleGenerate() {
      try {
        showPreview('');
        const t = document.getElementById('lookupType').value;
        const quoteIdVal = document.getElementById('quoteId').value || '';
        const usernameVal = document.getElementById('username').value || '';
        const emailVal = document.getElementById('email').value || '';
        const value = t === 'quoteId' ? quoteIdVal : (t === 'username' ? usernameVal : emailVal);
        if (!value.trim()) { showStatus('Please enter a lookup value.', 'error'); return; }
        showStatus('Resolving quote...', 'info');
        const quoteId = await resolveQuoteId(t, value);
        if (!quoteId) { showStatus('No quote found for the given value.', 'error'); return; }
        showStatus('Generating agreement...', 'info');
        const resp = await fetch('/api/agreements/generate-from-quote', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ quote_id: quoteId })});
        const result = await resp.json();
        if (!result.success) { showStatus('Error: ' + (result.message || 'generation failed'), 'error'); return; }
        showStatus('Agreement generated successfully.', 'success');
        renderHeader(result.agreement && result.agreement.template_data);
        renderPricingTable(result.pricing_table);
        showPreview((result.agreement && result.agreement.personalized_content) || 'No content');
      } catch(e) { showStatus('Error: ' + e.message, 'error'); }
    }

    document.addEventListener('DOMContentLoaded', toggleLookupFields);
  </script>
</body>
</html>

