<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Builder - Agreement Generator</title>
    
    <!-- Signature Pad Library -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .preview-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 800px;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Agreement Preview Styles */
        .agreement-preview {
            background: white;
            padding: 40px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        .agreement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .company-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .company-logo img {
            height: 60px;
        }

        .company-name {
            font-size: 24px;
            font-weight: bold;
            color: #1a73e8;
        }

        .microsoft-partner {
            text-align: right;
        }

        .microsoft-partner img {
            height: 50px;
        }

        .agreement-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin: 30px 0;
            color: #333;
        }

        .service-description {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #555;
        }

        .service-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
        }

        .service-table th {
            background: #b8dff0;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #999;
        }

        .service-table td {
            padding: 12px;
            border: 1px solid #999;
            vertical-align: top;
        }

        .service-table .job-requirement {
            text-align: center;
            font-weight: bold;
        }

        .service-table .price {
            text-align: right;
            font-weight: bold;
        }

        .total-price {
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
        }

        .payment-notes {
            background: #b8dff0;
            padding: 15px;
            margin: 25px 0;
            border-radius: 5px;
        }

        .payment-notes h4 {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .payment-notes ul {
            list-style-type: disc;
            margin-left: 20px;
        }

        .payment-notes li {
            margin-bottom: 8px;
        }

        .saas-agreement {
            background: #b8dff0;
            padding: 15px;
            margin: 25px 0;
            border-radius: 5px;
        }

        .saas-agreement h4 {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e1e5e9;
        }

        .signature-block {
            text-align: center;
        }

        .signature-block h4 {
            font-weight: bold;
            margin-bottom: 20px;
            text-decoration: underline;
        }

        .signature-line {
            border-bottom: 2px solid #333;
            height: 50px;
            margin: 10px 0;
            position: relative;
        }

        .signature-canvas {
            border: 2px solid #333;
            width: 100%;
            height: 80px;
            cursor: crosshair;
        }

        .signature-text {
            width: 100%;
            padding: 10px;
            border: 2px solid #333;
            text-align: center;
            font-family: cursive;
            font-size: 18px;
        }

        .signature-info {
            margin-top: 10px;
            text-align: left;
        }

        .signature-info input {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            border: none;
            border-bottom: 1px solid #333;
        }

        .terms-section {
            background: #b8dff0;
            padding: 15px;
            margin: 25px 0;
            border-radius: 5px;
        }

        .terms-section h4 {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .placeholder {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            color: #856404;
        }

        .quote-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quote-selector select {
            flex: 1;
        }

        .signature-options {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .signature-options button {
            padding: 5px 10px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ Template Builder</h1>
            <p>Create professional agreement templates with signature tracking</p>
        </div>

        <!-- Navigation -->
        <div class="nav-bar">
            <a href="/" class="nav-btn">üè† Home</a>
            <a href="/quote-calculator" class="nav-btn">üßÆ Quote Calculator</a>
            <a href="/client-management" class="nav-btn">üë• Client Management</a>
            <a href="/quote-management" class="nav-btn">üìã Quote Management</a>
            <a href="/approval-dashboard" class="nav-btn">‚úÖ Approval Dashboard</a>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Control Panel -->
            <div class="control-panel">
                <!-- Template Management Section -->
                <div class="section">
                    <h3>üìã Template Management</h3>
                    <div class="form-group">
                        <label class="form-label">Load Existing Template</label>
                        <div class="quote-selector">
                            <select id="templateSelect" class="form-select" onchange="loadTemplate()">
                                <option value="">Select template to load...</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadTemplates()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="saveAsNewTemplate()">üíæ Save As New Template</button>
                        <button class="btn btn-secondary" onclick="updateCurrentTemplate()">‚úèÔ∏è Update Current Template</button>
                    </div>
                </div>

                <!-- Data Source Section -->
                <div class="section">
                    <h3>üìä Data Source</h3>
                    <div class="form-group">
                        <label class="form-label">Select Quote/Deal</label>
                        <div class="quote-selector">
                            <select id="dataSourceType" class="form-select" onchange="onDataSourceChange()">
                                <option value="quote">From Quote</option>
                                <option value="deal">From HubSpot Deal</option>
                                <option value="manual">Manual Entry</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadDataSources()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <select id="dataSourceSelect" class="form-select" onchange="loadDataSource()">
                            <option value="">Select data source...</option>
                        </select>
                    </div>
                </div>

                <!-- Company Information -->
                <div class="section">
                    <h3>üè¢ Company Information</h3>
                    <div class="form-group">
                        <label class="form-label">Your Company Name</label>
                        <input type="text" id="companyName" class="form-input" value="CloudFuze" placeholder="Your company name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company Address</label>
                        <input type="text" id="companyAddress" class="form-input" value="2500 Regency Parkway, Cary, NC 27518" placeholder="Company address">
                    </div>
                </div>

                <!-- Client Information -->
                <div class="section">
                    <h3>üë• Client Information</h3>
                    <div class="form-group">
                        <label class="form-label">Client Company</label>
                        <input type="text" id="clientCompany" class="form-input" placeholder="Client company name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Client Name</label>
                        <input type="text" id="clientName" class="form-input" placeholder="Client contact name">
                    </div>
                </div>

                <!-- Service Information -->
                <div class="section">
                    <h3>üõ†Ô∏è Service Information</h3>
                    <div class="form-group">
                        <label class="form-label">Service Type</label>
                        <input type="text" id="serviceType" class="form-input" placeholder="e.g., Slack to Teams Migration">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Service Description</label>
                        <textarea id="serviceDescription" class="form-input" rows="3" placeholder="Detailed service description"></textarea>
                    </div>
                </div>

                <!-- Pricing Information -->
                <div class="section">
                    <h3>üí∞ Pricing</h3>
                    <div class="form-group">
                        <label class="form-label">Total Price</label>
                        <input type="number" id="totalPrice" class="form-input" placeholder="2000.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select id="currency" class="form-select">
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>

                <!-- Term Information -->
                <div class="section">
                    <h3>üìÖ Agreement Terms</h3>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" id="startDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" id="endDate" class="form-input">
                    </div>
                </div>

                <!-- Signature Configuration -->
                <div class="section">
                    <h3>‚úçÔ∏è Signature Setup</h3>
                    <div class="form-group">
                        <label class="form-label">CEO/Manager Name</label>
                        <input type="text" id="ceoName" class="form-input" value="Adi Nandyala" placeholder="CEO/Manager name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">CEO/Manager Title</label>
                        <input type="text" id="ceoTitle" class="form-input" value="Director of operations" placeholder="CEO/Manager title">
                    </div>
                </div>

                <!-- Actions -->
                <div class="section">
                    <h3>üöÄ Actions</h3>
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px;">
                        <strong>üìã Complete 3-Page Agreement includes:</strong><br/>
                        ‚Ä¢ <strong>Page 1:</strong> Main agreement with pricing and terms<br/>
                        ‚Ä¢ <strong>Page 2:</strong> Signature page for CEO and client<br/>
                        ‚Ä¢ <strong>Page 3:</strong> Professional signature certificate
                    </div>
                    <button class="btn btn-success" onclick="updatePreview()">üîÑ Update Preview</button>
                    <button class="btn" onclick="generatePDF()">üìÑ Generate Complete 3-Page Agreement</button>
                    <button class="btn" onclick="sendForSignature()">üìß Send for Signature</button>
                    <button class="btn btn-secondary" onclick="saveTemplate()">üíæ Save Template</button>
                    <div id="actionMessages"></div>
                </div>

                <!-- Signature Certificate Section -->
                <div class="section">
                    <h3>üèÜ Signature Certificate</h3>
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px;">
                        <strong>üìã Complete 3-Page Agreement includes:</strong><br/>
                        ‚Ä¢ <strong>Page 1:</strong> Main agreement with pricing and terms<br/>
                        ‚Ä¢ <strong>Page 2:</strong> Signature page for CEO and client<br/>
                        ‚Ä¢ <strong>Page 3:</strong> Professional signature certificate
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select Completed Agreement</label>
                        <select id="completedAgreementsSelect" class="form-select" onchange="selectAgreementForCertificate()">
                            <option value="">Select a completed agreement...</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadCompletedAgreements()">üîÑ Refresh</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Or Enter Agreement ID Manually</label>
                        <input type="text" id="certificateAgreementId" class="form-input" placeholder="Enter agreement ID manually">
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="generateSignatureCertificate()">üèÜ Generate Signature Certificate</button>
                        <button class="btn btn-secondary" onclick="viewAllCertificates()">üìã View All Certificates</button>
                        <button class="btn" onclick="signAsCEO()">üëî Sign as CEO</button>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="preview-panel">
                <h3>üìÑ Agreement Preview</h3>
                <div id="agreementPreview">
                    <div class="loading">
                        <p>Configure your agreement settings to see the preview...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let quotes = [];
        let deals = [];
        let templates = [];
        let currentTemplateId = null;
        let currentSignaturePads = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDataSources();
            loadTemplates();
            loadCompletedAgreements();
            updatePreview();
            
            // Set default dates
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            
            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            document.getElementById('endDate').value = nextMonth.toISOString().split('T')[0];
        });

        // Load templates
        async function loadTemplates() {
            try {
                showMessage('Loading templates...', 'info');
                
                const response = await fetch('/api/templates');
                if (response.ok) {
                    const data = await response.json();
                    templates = data.templates || [];
                    updateTemplateOptions();
                    showMessage('Templates loaded successfully!', 'success');
                } else {
                    showMessage('Error loading templates', 'error');
                }
                
            } catch (error) {
                console.error('Error loading templates:', error);
                showMessage('Error loading templates', 'error');
            }
        }

        // Update template options
        function updateTemplateOptions() {
            const select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">Select template to load...</option>';
            
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template._id;
                option.textContent = `${template.name} (${template.category}) - ${new Date(template.created_at).toLocaleDateString()}`;
                select.appendChild(option);
            });
        }

        // Load selected template
        async function loadTemplate() {
            const templateId = document.getElementById('templateSelect').value;
            if (!templateId) return;

            try {
                const template = templates.find(t => t._id === templateId);
                if (template) {
                    populateFromTemplate(template);
                    currentTemplateId = templateId;
                    updatePreview();
                    showMessage(`Template "${template.name}" loaded successfully!`, 'success');
                }
            } catch (error) {
                console.error('Error loading template:', error);
                showMessage('Error loading template', 'error');
            }
        }

        // Populate form from template data
        function populateFromTemplate(template) {
            // Extract data from template content or metadata
            // This is a simplified version - you might need to parse the template content
            if (template.metadata) {
                const meta = template.metadata;
                if (meta.companyName) document.getElementById('companyName').value = meta.companyName;
                if (meta.companyAddress) document.getElementById('companyAddress').value = meta.companyAddress;
                if (meta.ceoName) document.getElementById('ceoName').value = meta.ceoName;
                if (meta.ceoTitle) document.getElementById('ceoTitle').value = meta.ceoTitle;
            }
        }

        // Save as new template
        async function saveAsNewTemplate() {
            try {
                const templateName = prompt('Enter template name:');
                if (!templateName) return;

                showMessage('Saving template...', 'info');
                
                const templateData = {
                    name: templateName,
                    description: 'Custom agreement template with signature tracking',
                    category: 'agreements',
                    content: document.getElementById('agreementPreview').innerHTML,
                    placeholders: [
                        'companyName', 'companyAddress', 'clientCompany', 'clientName',
                        'serviceType', 'serviceDescription', 'totalPrice', 'currency',
                        'startDate', 'endDate', 'ceoName', 'ceoTitle'
                    ],
                    type: 'html',
                    metadata: {
                        companyName: document.getElementById('companyName').value,
                        companyAddress: document.getElementById('companyAddress').value,
                        ceoName: document.getElementById('ceoName').value,
                        ceoTitle: document.getElementById('ceoTitle').value
                    }
                };

                const response = await fetch('/api/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('Template saved successfully!', 'success');
                    loadTemplates(); // Refresh template list
                } else {
                    const error = await response.json();
                    showMessage(`Error saving template: ${error.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Error saving template:', error);
                showMessage('Error saving template', 'error');
            }
        }

        // Update current template
        async function updateCurrentTemplate() {
            if (!currentTemplateId) {
                showMessage('No template selected to update', 'error');
                return;
            }

            try {
                showMessage('Updating template...', 'info');
                
                const templateData = {
                    content: document.getElementById('agreementPreview').innerHTML,
                    metadata: {
                        companyName: document.getElementById('companyName').value,
                        companyAddress: document.getElementById('companyAddress').value,
                        ceoName: document.getElementById('ceoName').value,
                        ceoTitle: document.getElementById('ceoTitle').value
                    }
                };

                const response = await fetch(`/api/templates/${currentTemplateId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });

                if (response.ok) {
                    showMessage('Template updated successfully!', 'success');
                    loadTemplates(); // Refresh template list
                } else {
                    const error = await response.json();
                    showMessage(`Error updating template: ${error.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Error updating template:', error);
                showMessage('Error updating template', 'error');
            }
        }

        // Load data sources (quotes and deals)
        async function loadDataSources() {
            try {
                showMessage('Loading data sources...', 'info');
                
                // Load quotes
                const quotesResponse = await fetch('/api/quotes/list');
                if (quotesResponse.ok) {
                    const quotesData = await quotesResponse.json();
                    quotes = quotesData.quotes || [];
                }

                // Load HubSpot deals
                const dealsResponse = await fetch('/api/hubspot/fetch-deals');
                if (dealsResponse.ok) {
                    const dealsData = await dealsResponse.json();
                    deals = dealsData.deals || [];
                }

                updateDataSourceOptions();
                showMessage('Data sources loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading data sources:', error);
                showMessage('Error loading data sources', 'error');
            }
        }

        // Update data source options based on type
        function onDataSourceChange() {
            updateDataSourceOptions();
        }

        function updateDataSourceOptions() {
            const type = document.getElementById('dataSourceType').value;
            const select = document.getElementById('dataSourceSelect');
            
            select.innerHTML = '<option value="">Select data source...</option>';
            
            if (type === 'quote') {
                quotes.forEach(quote => {
                    const option = document.createElement('option');
                    option.value = quote._id;
                    option.textContent = `${quote.client?.name || 'Unknown'} - ${quote.client?.company || 'Unknown'} ($${quote.quote?.total_cost || 0})`;
                    select.appendChild(option);
                });
            } else if (type === 'deal') {
                deals.forEach(deal => {
                    const option = document.createElement('option');
                    option.value = deal.id;
                    option.textContent = `${deal.dealname || 'Unknown Deal'} - ${deal.company || 'Unknown'} ($${deal.amount || 0})`;
                    select.appendChild(option);
                });
            }
        }

        // Load selected data source
        async function loadDataSource() {
            const type = document.getElementById('dataSourceType').value;
            const id = document.getElementById('dataSourceSelect').value;
            
            if (!id) return;

            try {
                if (type === 'quote') {
                    const quote = quotes.find(q => q._id === id);
                    if (quote) {
                        populateFromQuote(quote);
                    }
                } else if (type === 'deal') {
                    const deal = deals.find(d => d.id === id);
                    if (deal) {
                        populateFromDeal(deal);
                    }
                }
                
                updatePreview();
                
            } catch (error) {
                console.error('Error loading data source:', error);
                showMessage('Error loading data source', 'error');
            }
        }

        // Populate form from quote data
        function populateFromQuote(quote) {
            document.getElementById('clientCompany').value = quote.client?.company || '';
            document.getElementById('clientName').value = quote.client?.name || '';
            document.getElementById('serviceType').value = quote.client?.serviceType || '';
            document.getElementById('totalPrice').value = quote.quote?.total_cost || '';
            
            // Build service description from quote configuration
            if (quote.configuration) {
                const config = quote.configuration;
                let description = `Service: ${quote.client?.serviceType || 'Custom Service'}\n`;
                
                if (config.users) description += `Users: ${config.users}\n`;
                if (config.channels) description += `Channels: ${config.channels}\n`;
                if (config.features) description += `Features: ${config.features.join(', ')}\n`;
                
                document.getElementById('serviceDescription').value = description;
            }
        }

        // Populate form from deal data
        function populateFromDeal(deal) {
            document.getElementById('clientCompany').value = deal.company || '';
            document.getElementById('clientName').value = deal.dealname || '';
            document.getElementById('serviceType').value = deal.dealtype || '';
            document.getElementById('totalPrice').value = deal.amount || '';
            document.getElementById('serviceDescription').value = `Deal: ${deal.dealname}\nStage: ${deal.dealstage}\nPipeline: ${deal.pipeline}`;
        }

        // Update preview
        function updatePreview() {
            const previewDiv = document.getElementById('agreementPreview');
            
            const data = {
                companyName: document.getElementById('companyName').value || 'CloudFuze',
                companyAddress: document.getElementById('companyAddress').value || '2500 Regency Parkway, Cary, NC 27518',
                clientCompany: document.getElementById('clientCompany').value || 'Client Company',
                clientName: document.getElementById('clientName').value || 'Client Name',
                serviceType: document.getElementById('serviceType').value || 'Service Type',
                serviceDescription: document.getElementById('serviceDescription').value || 'Service description will appear here',
                totalPrice: document.getElementById('totalPrice').value || '0.00',
                currency: document.getElementById('currency').value || 'USD',
                startDate: document.getElementById('startDate').value || new Date().toISOString().split('T')[0],
                endDate: document.getElementById('endDate').value || new Date().toISOString().split('T')[0],
                ceoName: document.getElementById('ceoName').value || 'CEO Name',
                ceoTitle: document.getElementById('ceoTitle').value || 'CEO Title'
            };

            previewDiv.innerHTML = generateAgreementHTML(data);
            
            // Initialize signature pads after DOM update
            setTimeout(initializeSignaturePads, 100);
        }

        // Generate agreement HTML
        function generateAgreementHTML(data) {
            return `
                <div class="agreement-preview">
                    <!-- Header with logos -->
                    <div class="agreement-header">
                        <div class="company-logo">
                            <div class="company-name">${data.companyName}</div>
                        </div>
                        <div class="microsoft-partner">
                            <div style="font-weight: bold; color: #666;">Microsoft Partner</div>
                            <div style="font-size: 12px; color: #888;">Gold Cloud Productivity</div>
                        </div>
                    </div>

                    <!-- Agreement Title -->
                    <div class="agreement-title">
                        ${data.companyName} Purchase Agreement for ${data.clientCompany}
                    </div>

                    <!-- Service Description -->
                    <div class="service-description">
                        This agreement provides <strong>${data.clientCompany}</strong> with pricing for use of the ${data.companyName}'s X-Change Enterprise Data Migration Solution:
                    </div>

                    <!-- Service Table Header -->
                    <div style="background: #b8dff0; padding: 10px; text-align: center; font-weight: bold; border: 1px solid #999;">
                        Cloud-Hosted SaaS Solution | Managed Migration | Dedicated Migration Manager
                    </div>

                    <!-- Service Details Table -->
                    <table class="service-table">
                        <thead>
                            <tr>
                                <th>Job Requirement</th>
                                <th>Description</th>
                                <th>Migration Type</th>
                                <th>Price(${data.currency})</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="job-requirement">${data.companyName} X-Change Data Migration</td>
                                <td>
                                    ${data.serviceDescription.replace(/\n/g, '<br>')}
                                    <hr style="margin: 10px 0;">
                                    <strong>Valid for One Month</strong>
                                </td>
                                <td style="text-align: center;">
                                    Managed Migration<br>
                                    One-Time
                                </td>
                                <td class="price">$${parseFloat(data.totalPrice || 0).toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Total Price -->
                    <div class="total-price">
                        <strong>Total Price: $${parseFloat(data.totalPrice || 0).toFixed(2)}</strong>
                    </div>

                    <!-- Payment Notes -->
                    <div class="payment-notes">
                        <h4>Important Payment Notes:</h4>
                        <ul>
                            <li>100% pre-payment before initiating the migration.</li>
                            <li>All prices are in US dollars (${data.currency}).</li>
                            <li>Any required sales taxes are not included in the above agreement.</li>
                            <li>Overage Charges: $35 per User | $500 per Additional Month</li>
                            <li>Initial Service Term: ${data.startDate} till ${data.endDate}</li>
                        </ul>
                    </div>

                    <!-- SaaS Agreement -->
                    <div class="saas-agreement">
                        <h4>SAAS SERVICE AGREEMENT:</h4>
                        <p>
                            This SaaS Services Agreement ("Agreement") is entered on this <strong>${new Date().toLocaleDateString()}</strong> (the "Effective Date") between 
                            <strong>${data.companyName}, Inc.</strong> with a place of business at <strong>${data.companyAddress}</strong> ("Company"), and the 
                            Customer listed above ("Customer"). This Agreement includes and incorporates the above Order Form, In Scope 
                            Features list Exhibit ("Exhibit 1"), Out of Scope Features list Exhibit ("Exhibit 2"), all attachments hereto, as well as 
                            the attached Terms and Conditions and contains, among other things, warranty disclaimers, liability limitations and 
                            use limitations. There shall be no force or effect to any different terms of any related purchase order or similar form 
                            even if signed by the parties after the date hereof.
                        </p>
                    </div>

                    <!-- Signature Section -->
                    <div class="signature-section">
                        <!-- Company Signature -->
                        <div class="signature-block">
                            <h4>For ${data.companyName}, Inc.</h4>
                            
                            <div class="signature-options">
                                <button class="btn btn-secondary" onclick="switchSignatureMode('ceo', 'text')">Text</button>
                                <button class="btn btn-secondary" onclick="switchSignatureMode('ceo', 'draw')">Draw</button>
                                <button class="btn btn-danger" onclick="clearSignature('ceo')">Clear</button>
                            </div>
                            
                            <div id="ceoSignatureContainer">
                                <canvas id="ceoSignatureCanvas" class="signature-canvas" style="display: none;"></canvas>
                                <input type="text" id="ceoSignatureText" class="signature-text" placeholder="Type signature here" style="display: block;">
                            </div>
                            
                            <div class="signature-info">
                                <div>Name: <input type="text" value="${data.ceoName}" id="ceoSignatureName"></div>
                                <div>Title: <input type="text" value="${data.ceoTitle}" id="ceoSignatureTitle"></div>
                                <div>Date: <input type="date" value="${new Date().toISOString().split('T')[0]}" id="ceoSignatureDate"></div>
                            </div>
                        </div>

                        <!-- Client Signature -->
                        <div class="signature-block">
                            <h4>For ${data.clientCompany}</h4>
                            
                            <div class="signature-options">
                                <button class="btn btn-secondary" onclick="switchSignatureMode('client', 'text')">Text</button>
                                <button class="btn btn-secondary" onclick="switchSignatureMode('client', 'draw')">Draw</button>
                                <button class="btn btn-danger" onclick="clearSignature('client')">Clear</button>
                            </div>
                            
                            <div id="clientSignatureContainer">
                                <canvas id="clientSignatureCanvas" class="signature-canvas" style="display: none;"></canvas>
                                <input type="text" id="clientSignatureText" class="signature-text" placeholder="Type signature here" style="display: block;">
                            </div>
                            
                            <div class="signature-info">
                                <div>Name: <input type="text" value="${data.clientName}" id="clientSignatureName"></div>
                                <div>Title: <input type="text" placeholder="Client Title" id="clientSignatureTitle"></div>
                                <div>Date: <input type="date" value="${new Date().toISOString().split('T')[0]}" id="clientSignatureDate"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Terms and Conditions -->
                    <div class="terms-section">
                        <h4>TERMS AND CONDITIONS</h4>
                        <p>
                            Subject to the terms of this Agreement, Company will use commercially reasonable efforts to provide Customer the 
                            Migration Services. As part of the registration process, Customer will identify an administrative username and 
                            password for Customer's Company account. Company reserves the right to refuse registration of or cancel 
                            passwords it deems inappropriate.
                        </p>
                    </div>
                </div>
            `;
        }

        // Initialize signature pads
        function initializeSignaturePads() {
            // Initialize CEO signature pad
            const ceoCanvas = document.getElementById('ceoSignatureCanvas');
            if (ceoCanvas && !currentSignaturePads.ceo) {
                currentSignaturePads.ceo = new SignaturePad(ceoCanvas, {
                    backgroundColor: 'rgba(255, 255, 255, 0)',
                    penColor: 'rgb(0, 0, 0)'
                });
            }

            // Initialize Client signature pad
            const clientCanvas = document.getElementById('clientSignatureCanvas');
            if (clientCanvas && !currentSignaturePads.client) {
                currentSignaturePads.client = new SignaturePad(clientCanvas, {
                    backgroundColor: 'rgba(255, 255, 255, 0)',
                    penColor: 'rgb(0, 0, 0)'
                });
            }
        }

        // Switch signature mode (text/draw)
        function switchSignatureMode(type, mode) {
            const textInput = document.getElementById(`${type}SignatureText`);
            const canvas = document.getElementById(`${type}SignatureCanvas`);
            
            if (mode === 'text') {
                textInput.style.display = 'block';
                canvas.style.display = 'none';
            } else {
                textInput.style.display = 'none';
                canvas.style.display = 'block';
                
                // Reinitialize signature pad if needed
                if (!currentSignaturePads[type]) {
                    initializeSignaturePads();
                }
            }
        }

        // Clear signature
        function clearSignature(type) {
            const textInput = document.getElementById(`${type}SignatureText`);
            const signaturePad = currentSignaturePads[type];
            
            if (textInput) {
                textInput.value = '';
            }
            
            if (signaturePad) {
                signaturePad.clear();
            }
        }

        // Generate PDF
        async function generatePDF() {
            try {
                showMessage('Generating PDF...', 'info');
                
                const templateData = gatherTemplateData();
                
                const response = await fetch('/api/templates/generate-agreement-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    showMessage(`Error generating PDF: ${error.message}`, 'error');
                    return;
                }

                // Check if response is a PDF file
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/pdf')) {
                    // Direct PDF download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `agreement_${new Date().toISOString().slice(0,10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showMessage('‚úÖ Complete 3-page agreement generated and downloaded successfully!', 'success');
                } else {
                    // Fallback to JSON response (for backward compatibility)
                    const responseData = await response.json();
                    if (!responseData.success) {
                        showMessage(`Error: ${responseData.message}`, 'error');
                        return;
                    }
                    await downloadGeneratedPDF(responseData.agreement_id);
                    showMessage('‚úÖ PDF generated and downloaded successfully!', 'success');
                }
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Error generating PDF', 'error');
            }
        }

        // Download generated PDF
        async function downloadGeneratedPDF(agreementId) {
            try {
                // Get the PDF from the stored agreement
                const response = await fetch(`/api/agreements/download/${agreementId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to download PDF');
                }

                // Download the PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `agreement_${agreementId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Error downloading PDF:', error);
                showMessage('Error downloading PDF', 'error');
            }
        }

        // Gather template data
        function gatherTemplateData() {
            // Get signature data
            const ceoSignature = getSignatureData('ceo');
            const clientSignature = getSignatureData('client');
            
            return {
                companyName: document.getElementById('companyName').value,
                companyAddress: document.getElementById('companyAddress').value,
                clientCompany: document.getElementById('clientCompany').value,
                clientName: document.getElementById('clientName').value,
                serviceType: document.getElementById('serviceType').value,
                serviceDescription: document.getElementById('serviceDescription').value,
                totalPrice: parseFloat(document.getElementById('totalPrice').value || 0),
                currency: document.getElementById('currency').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                ceoSignature: ceoSignature,
                clientSignature: clientSignature,
                generatedAt: new Date().toISOString()
            };
        }

        // Get signature data
        function getSignatureData(type) {
            const textInput = document.getElementById(`${type}SignatureText`);
            const canvas = document.getElementById(`${type}SignatureCanvas`);
            const signaturePad = currentSignaturePads[type];
            
            let signatureData = null;
            let signatureType = 'none';
            
            if (textInput && textInput.style.display !== 'none' && textInput.value.trim()) {
                signatureData = textInput.value.trim();
                signatureType = 'text';
            } else if (canvas && canvas.style.display !== 'none' && signaturePad && !signaturePad.isEmpty()) {
                signatureData = signaturePad.toDataURL();
                signatureType = 'drawn';
            }
            
            return {
                type: signatureType,
                data: signatureData,
                name: document.getElementById(`${type}SignatureName`).value,
                title: document.getElementById(`${type}SignatureTitle`).value,
                date: document.getElementById(`${type}SignatureDate`).value,
                timestamp: new Date().toISOString()
            };
        }

        // Send for signature
        async function sendForSignature() {
            try {
                // Validate required fields
                const clientEmail = prompt('Enter client email address:');
                if (!clientEmail || !clientEmail.includes('@')) {
                    showMessage('Valid client email is required', 'error');
                    return;
                }

                showMessage('Creating agreement and sending signature request...', 'info');
                
                // First generate and save the agreement
                const templateData = gatherTemplateData();
                templateData.clientEmail = clientEmail;
                
                // Generate the agreement (but don't download it)
                templateData.signature_workflow = true; // Add parameter to indicate signature workflow
                const response = await fetch('/api/templates/generate-agreement-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    showMessage(`Error creating agreement: ${error.message}`, 'error');
                    return;
                }

                // Get the agreement ID from the response
                const responseData = await response.json();
                if (!responseData.success || !responseData.agreement_id) {
                    showMessage('Error: Could not get agreement ID from response', 'error');
                    return;
                }
                
                const agreementId = responseData.agreement_id;
                
                // Send signature request
                const signatureResponse = await fetch('/api/agreements/send-for-signature', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agreement_id: agreementId,
                        client_email: clientEmail,
                        client_name: templateData.clientName || 'Client'
                    })
                });

                if (signatureResponse.ok) {
                    const result = await signatureResponse.json();
                    showMessage(`‚úÖ Signature request sent to ${clientEmail}!`, 'success');
                    
                    // Show signature URL for reference
                    const signatureUrl = result.signature_url;
                    if (signatureUrl) {
                        setTimeout(() => {
                            showMessage(`Signature URL: ${window.location.origin}${signatureUrl}`, 'info');
                        }, 2000);
                    }
                } else {
                    const error = await signatureResponse.json();
                    showMessage(`Error sending signature request: ${error.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Error sending signature request:', error);
                showMessage('Error sending signature request', 'error');
            }
        }

        // Save template
        async function saveTemplate() {
            try {
                showMessage('Saving template...', 'info');
                
                const templateData = {
                    name: `Agreement Template - ${new Date().toLocaleDateString()}`,
                    description: 'Custom agreement template with signature tracking',
                    category: 'agreements',
                    content: document.getElementById('agreementPreview').innerHTML,
                    placeholders: [
                        'companyName', 'companyAddress', 'clientCompany', 'clientName',
                        'serviceType', 'serviceDescription', 'totalPrice', 'currency',
                        'startDate', 'endDate', 'ceoName', 'ceoTitle'
                    ],
                    type: 'html'
                };

                const response = await fetch('/api/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage('Template saved successfully!', 'success');
                } else {
                    const error = await response.json();
                    showMessage(`Error saving template: ${error.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Error saving template:', error);
                showMessage('Error saving template', 'error');
            }
        }

        // Load completed agreements for certificate generation
        async function loadCompletedAgreements() {
            try {
                showMessage('Loading completed agreements...', 'info');
                
                const response = await fetch('/api/agreements/completed');
                if (response.ok) {
                    const data = await response.json();
                    const agreements = data.agreements || [];
                    updateCompletedAgreementsOptions(agreements);
                    showMessage('Completed agreements loaded!', 'success');
                } else {
                    showMessage('Error loading completed agreements', 'error');
                }
                
            } catch (error) {
                console.error('Error loading completed agreements:', error);
                showMessage('Error loading completed agreements', 'error');
            }
        }

        // Update completed agreements dropdown
        function updateCompletedAgreementsOptions(agreements) {
            const select = document.getElementById('completedAgreementsSelect');
            select.innerHTML = '<option value="">Select a completed agreement...</option>';
            
            agreements.forEach(agreement => {
                const option = document.createElement('option');
                option.value = agreement._id;
                const completedDate = new Date(agreement.completed_at).toLocaleDateString();
                option.textContent = `${agreement.client_name || agreement.client_company || 'Unknown'} - ${agreement.service_type || 'Service'} (Completed: ${completedDate})`;
                select.appendChild(option);
            });
        }

        // Select agreement for certificate generation
        function selectAgreementForCertificate() {
            const agreementId = document.getElementById('completedAgreementsSelect').value;
            if (agreementId) {
                document.getElementById('certificateAgreementId').value = agreementId;
            }
        }

        // View all certificates
        async function viewAllCertificates() {
            try {
                showMessage('Loading certificates...', 'info');
                
                const response = await fetch('/api/agreements/certificates');
                if (response.ok) {
                    const data = await response.json();
                    const certificates = data.certificates || [];
                    displayCertificates(certificates);
                } else {
                    showMessage('Error loading certificates', 'error');
                }
                
            } catch (error) {
                console.error('Error loading certificates:', error);
                showMessage('Error loading certificates', 'error');
            }
        }

        // Display certificates in a modal or new section
        function displayCertificates(certificates) {
            let html = '<div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0;">';
            html += '<h4>üìã Generated Signature Certificates</h4>';
            
            if (certificates.length === 0) {
                html += '<p>No certificates generated yet.</p>';
            } else {
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #f8f9fa;"><th style="padding: 10px; border: 1px solid #ddd;">Reference</th><th style="padding: 10px; border: 1px solid #ddd;">Document</th><th style="padding: 10px; border: 1px solid #ddd;">Created</th><th style="padding: 10px; border: 1px solid #ddd;">Actions</th></tr>';
                
                certificates.forEach(cert => {
                    const createdDate = new Date(cert.created_at).toLocaleDateString();
                    html += `<tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${cert.reference_number}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${cert.document_title}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${createdDate}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <button class="btn btn-secondary" onclick="downloadCertificate('${cert._id}')" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">Download</button>
                            <button class="btn btn-info" onclick="previewCertificate('${cert._id}')" style="padding: 5px 10px; font-size: 12px;">Preview</button>
                        </td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            html += '</div>';
            
            // Show in preview panel
            document.getElementById('agreementPreview').innerHTML = html;
        }
        
        // Preview certificate content without HTML tags
        function previewCertificate(certificateId) {
            // Find the certificate in the current certificates list
            fetch('/api/agreements/certificates')
                .then(response => response.json())
                .then(data => {
                    const certificates = data.certificates || [];
                    const cert = certificates.find(c => c._id === certificateId);
                    
                    if (cert) {
                        let html = '<div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0;">';
                        html += '<h4>üìã Certificate Preview</h4>';
                        html += `<p><strong>Reference:</strong> ${cert.reference_number}</p>`;
                        html += `<p><strong>Document:</strong> ${cert.document_title}</p>`;
                        html += `<p><strong>Created:</strong> ${new Date(cert.created_at).toLocaleString()}</p>`;
                        
                        html += '<h5>Signers:</h5>';
                        html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                        html += '<tr style="background: #f8f9fa;"><th style="padding: 10px; border: 1px solid #ddd;">Name</th><th style="padding: 10px; border: 1px solid #ddd;">Email</th><th style="padding: 10px; border: 1px solid #ddd;">Signed At</th><th style="padding: 10px; border: 1px solid #ddd;">IP Address</th></tr>';
                        
                        cert.signers.forEach(signer => {
                            const signedDate = new Date(signer.signed_at).toLocaleString();
                            html += `<tr>
                                <td style="padding: 10px; border: 1px solid #ddd;">${signer.name}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${signer.email}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${signedDate}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${signer.ip_address}</td>
                            </tr>`;
                        });
                        
                        html += '</table>';
                        html += '<p style="margin-top: 20px;"><em>This is a preview of the certificate data. The actual PDF contains properly formatted content.</em></p>';
                        html += '</div>';
                        
                        document.getElementById('agreementPreview').innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error loading certificate:', error);
                    showMessage('Error loading certificate preview', 'error');
                });
        }

        // Download certificate
        async function downloadCertificate(certificateId) {
            try {
                const response = await fetch(`/api/agreements/download-certificate/${certificateId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `signature_certificate_${certificateId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showMessage('Certificate downloaded successfully!', 'success');
                } else {
                    showMessage('Error downloading certificate', 'error');
                }
            } catch (error) {
                console.error('Error downloading certificate:', error);
                showMessage('Error downloading certificate', 'error');
            }
        }

        // Generate signature certificate
        async function generateSignatureCertificate() {
            try {
                const agreementId = document.getElementById('certificateAgreementId').value.trim();
                if (!agreementId) {
                    showMessage('Please enter an Agreement ID', 'error');
                    return;
                }

                showMessage('Generating signature certificate...', 'info');
                
                const response = await fetch('/api/agreements/generate-signature-certificate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agreement_id: agreementId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showMessage(`Error generating certificate: ${error.message}`, 'error');
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    // Download the certificate PDF
                    const blob = await fetch(`/api/agreements/download-certificate/${result.certificate_id}`).then(r => r.blob());
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `signature_certificate_${agreementId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showMessage('‚úÖ Signature certificate generated and downloaded!', 'success');
                } else {
                    showMessage(`Error: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Error generating signature certificate:', error);
                showMessage('Error generating signature certificate', 'error');
            }
        }

        function signAsCEO() {
            const agreementId = document.getElementById('certificateAgreementId').value.trim();
            
            if (!agreementId) {
                showMessage('Please enter an agreement ID to sign as CEO', 'error');
                return;
            }
            
            // Open CEO signature page in new tab
            window.open(`/sign-ceo/${agreementId}`, '_blank');
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('actionMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : type === 'error' ? 'error-message' : 'loading';
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }
    </script>
</body>
</html>
