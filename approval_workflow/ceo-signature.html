<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEO Document Signature Request</title>
    
    <!-- Signature Pad Library -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .signature-request-info {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 5px solid #28a745;
        }

        .signature-request-info h3 {
            color: #155724;
            margin-bottom: 10px;
        }

        .signature-request-info p {
            color: #666;
            line-height: 1.6;
        }

        .document-preview {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 30px;
            margin: 30px 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .signature-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 30px;
            margin: 30px 0;
        }

        .signature-section h3 {
            color: #856404;
            margin-bottom: 20px;
            text-align: center;
        }

        .signature-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            font-size: 16px;
            padding: 15px 30px;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .signature-canvas {
            border: 2px solid #333;
            width: 100%;
            height: 120px;
            cursor: crosshair;
            border-radius: 5px;
        }

        .signature-text {
            width: 100%;
            padding: 15px;
            border: 2px solid #333;
            text-align: center;
            font-family: cursive;
            font-size: 20px;
            border-radius: 5px;
        }

        .signature-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .agreement-preview {
            font-size: 14px;
            line-height: 1.6;
        }

        .agreement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .company-name {
            font-size: 24px;
            font-weight: bold;
            color: #1a73e8;
        }

        .microsoft-partner {
            text-align: right;
            font-weight: bold;
            color: #666;
        }

        .agreement-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
        }

        .service-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 13px;
        }

        .service-table th {
            background: #b8dff0;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #999;
        }

        .service-table td {
            padding: 10px;
            border: 1px solid #999;
            vertical-align: top;
        }

        .payment-notes {
            background: #b8dff0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 13px;
        }

        .payment-notes h4 {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .payment-notes ul {
            list-style-type: disc;
            margin-left: 20px;
        }

        .payment-notes li {
            margin-bottom: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
        }

        .signature-actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e1e5e9;
        }

        .already-signed {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .company-signature {
            background: #f8f9fa;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }

        .terms-section {
            background: #b8dff0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 13px;
        }

        .terms-section h4 {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .signature-info {
                grid-template-columns: 1fr;
            }
            
            .signature-options {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üëî CEO Document Signature Request</h1>
            <p>Please review and sign the agreement as company representative</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Loading State -->
            <div id="loadingState" class="loading">
                <h3>Loading document...</h3>
                <p>Please wait while we fetch your signature request.</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error-message" style="display: none;">
                <h3>Document Not Found</h3>
                <p>The signature request you're looking for could not be found or may have expired.</p>
            </div>

            <!-- Main Content -->
            <div id="mainContent" style="display: none;">
                <!-- Signature Request Info -->
                <div class="signature-request-info">
                    <h3>üìù CEO Signature Request</h3>
                    <p id="requestInfo">You have been requested to review and sign this agreement as the company representative. Please read through the document carefully before providing your signature.</p>
                </div>

                <!-- Document Preview -->
                <div class="document-preview">
                    <div id="documentContent">
                        <!-- Agreement content will be loaded here -->
                    </div>
                </div>

                <!-- CEO Signature Section -->
                <div id="signatureSection" class="signature-section">
                    <h3>‚úçÔ∏è CEO Signature Required</h3>
                    
                    <div class="signature-options">
                        <button class="btn btn-secondary" onclick="switchSignatureMode('text')">üìù Type Signature</button>
                        <button class="btn btn-secondary" onclick="switchSignatureMode('draw')">‚úèÔ∏è Draw Signature</button>
                        <button class="btn btn-danger" onclick="clearSignature()">üóëÔ∏è Clear</button>
                    </div>
                    
                    <div id="signatureContainer">
                        <canvas id="signatureCanvas" class="signature-canvas" style="display: none;"></canvas>
                        <input type="text" id="signatureText" class="signature-text" placeholder="Type your full name here" style="display: block;">
                    </div>
                    
                    <div class="signature-info">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="signerName" class="form-input" placeholder="CEO full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Title/Position</label>
                            <input type="text" id="signerTitle" class="form-input" placeholder="CEO, Director, etc.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="signerEmail" class="form-input" placeholder="ceo@company.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" id="signatureDate" class="form-input" required>
                        </div>
                    </div>

                    <div class="signature-actions">
                        <button class="btn btn-success" onclick="submitSignature()">‚úÖ Sign as CEO</button>
                        <div id="signatureMessages"></div>
                    </div>
                </div>

                <!-- Already Signed State -->
                <div id="alreadySignedSection" class="already-signed" style="display: none;">
                    <h3>‚úÖ Document Already Signed</h3>
                    <p>You have already signed this document as CEO. Thank you for your prompt response!</p>
                    <p><strong>Signed on:</strong> <span id="signedDate"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let agreementData = null;
        let signaturePad = null;
        let currentAgreementId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Get agreement ID from URL
            const pathParts = window.location.pathname.split('/');
            currentAgreementId = pathParts[pathParts.length - 1];
            
            if (!currentAgreementId) {
                showError('No agreement ID provided in URL');
                return;
            }

            // Set default date
            document.getElementById('signatureDate').value = new Date().toISOString().split('T')[0];
            
            // Load agreement data
            loadAgreement();
        });

        // Load agreement data
        async function loadAgreement() {
            try {
                const response = await fetch(`/api/agreements/sign/${currentAgreementId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Failed to load agreement');
                }
                
                agreementData = result.agreement;
                displayAgreement();
                
            } catch (error) {
                console.error('Error loading agreement:', error);
                showError(`Error loading agreement: ${error.message}`);
            }
        }

        // Display agreement
        function displayAgreement() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Check if already signed by CEO
            if (agreementData.signatures && agreementData.signatures.ceo && agreementData.signatures.ceo.data) {
                showAlreadySigned();
                return;
            }
            
            // Pre-fill CEO info if available
            if (agreementData.company_name) {
                document.getElementById('signerName').value = 'CEO Name';
                document.getElementById('signerTitle').value = 'CEO';
            }
            if (agreementData.company_email) {
                document.getElementById('signerEmail').value = agreementData.company_email;
            }
            
            // Display document content
            const documentContent = generateAgreementHTML(agreementData);
            document.getElementById('documentContent').innerHTML = documentContent;
            
            // Update request info
            document.getElementById('requestInfo').innerHTML = 
                `You have been requested to review and sign this agreement as the CEO of <strong>${agreementData.company_name || 'the company'}</strong>. Please read through the document carefully before providing your signature.`;
        }

        // Generate agreement HTML
        function generateAgreementHTML(data) {
            return `
                <div class="agreement-preview">
                    <!-- Header -->
                    <div class="agreement-header">
                        <div class="company-name">${data.company_name || 'CloudFuze'}</div>
                        <div class="microsoft-partner">
                            Microsoft Partner<br>
                            <span style="font-size: 12px;">Gold Cloud Productivity</span>
                        </div>
                    </div>

                    <!-- Agreement Title -->
                    <div class="agreement-title">
                        ${data.company_name || 'CloudFuze'} Purchase Agreement for ${data.client_company || 'Your Company'}
                    </div>

                    <!-- Service Description -->
                    <div style="margin-bottom: 20px; line-height: 1.6;">
                        This agreement provides <strong>${data.client_company || 'Your Company'}</strong> with pricing for use of the ${data.company_name || 'CloudFuze'}'s X-Change Enterprise Data Migration Solution:
                    </div>

                    <!-- Service Table Header -->
                    <div style="background: #b8dff0; padding: 10px; text-align: center; font-weight: bold; border: 1px solid #999;">
                        Cloud-Hosted SaaS Solution | Managed Migration | Dedicated Migration Manager
                    </div>

                    <!-- Service Details Table -->
                    <table class="service-table">
                        <thead>
                            <tr>
                                <th>Job Requirement</th>
                                <th>Description</th>
                                <th>Migration Type</th>
                                <th>Price(${data.currency || 'USD'})</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align: center; font-weight: bold;">${data.company_name || 'CloudFuze'} X-Change Data Migration</td>
                                <td>
                                    ${(data.service_description || 'Migration service').replace(/\n/g, '<br>')}
                                    <hr style="margin: 10px 0;">
                                    <strong>Valid for One Month</strong>
                                </td>
                                <td style="text-align: center;">
                                    Managed Migration<br>
                                    One-Time
                                </td>
                                <td style="text-align: right; font-weight: bold;">$${parseFloat(data.total_price || 0).toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Total Price -->
                    <div style="text-align: right; font-size: 16px; font-weight: bold; margin-top: 10px;">
                        <strong>Total Price: $${parseFloat(data.total_price || 0).toFixed(2)}</strong>
                    </div>

                    <!-- Payment Notes -->
                    <div class="payment-notes">
                        <h4>Important Payment Notes:</h4>
                        <ul>
                            <li>100% pre-payment before initiating the migration.</li>
                            <li>All prices are in US dollars (${data.currency || 'USD'}).</li>
                            <li>Any required sales taxes are not included in the above agreement.</li>
                            <li>Overage Charges: $35 per User | $500 per Additional Month</li>
                            <li>Initial Service Term: ${data.start_date || 'TBD'} till ${data.end_date || 'TBD'}</li>
                        </ul>
                    </div>

                    ${data.signatures && data.signatures.client && data.signatures.client.data ? `
                    <!-- Client Signature (Already Signed) -->
                    <div class="company-signature">
                        <h4>‚úÖ Client Signature (Completed)</h4>
                        <p><strong>Name:</strong> ${data.signatures.client.name || 'N/A'}</p>
                        <p><strong>Title:</strong> ${data.signatures.client.title || 'N/A'}</p>
                        <p><strong>Date:</strong> ${data.signatures.client.date || 'N/A'}</p>
                        <p><strong>Signature:</strong> ${data.signatures.client.type === 'text' ? data.signatures.client.data : '[Digital Signature]'}</p>
                    </div>
                    ` : ''}

                    <!-- Terms and Conditions -->
                    <div class="terms-section">
                        <h4>TERMS AND CONDITIONS</h4>
                        <p>
                            Subject to the terms of this Agreement, Company will use commercially reasonable efforts to provide Customer the 
                            Migration Services. As part of the registration process, Customer will identify an administrative username and 
                            password for Customer's Company account. Company reserves the right to refuse registration of or cancel 
                            passwords it deems inappropriate.
                        </p>
                    </div>
                </div>
            `;
        }

        // Show already signed state
        function showAlreadySigned() {
            document.getElementById('signatureSection').style.display = 'none';
            document.getElementById('alreadySignedSection').style.display = 'block';
            
            if (agreementData.signatures && agreementData.signatures.ceo) {
                const signedDate = agreementData.signatures.ceo.date || 'Unknown date';
                document.getElementById('signedDate').textContent = signedDate;
            }
        }

        // Initialize signature pad
        function initializeSignaturePad() {
            const canvas = document.getElementById('signatureCanvas');
            if (canvas && !signaturePad) {
                signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgba(255, 255, 255, 0)',
                    penColor: 'rgb(0, 0, 0)'
                });
            }
        }

        // Switch signature mode
        function switchSignatureMode(mode) {
            const textInput = document.getElementById('signatureText');
            const canvas = document.getElementById('signatureCanvas');
            
            if (mode === 'text') {
                textInput.style.display = 'block';
                canvas.style.display = 'none';
            } else {
                textInput.style.display = 'none';
                canvas.style.display = 'block';
                initializeSignaturePad();
            }
        }

        // Clear signature
        function clearSignature() {
            const textInput = document.getElementById('signatureText');
            if (textInput) {
                textInput.value = '';
            }
            
            if (signaturePad) {
                signaturePad.clear();
            }
        }

        // Submit signature
        async function submitSignature() {
            try {
                // Validate required fields
                const name = document.getElementById('signerName').value.trim();
                const email = document.getElementById('signerEmail').value.trim();
                const date = document.getElementById('signatureDate').value;
                
                if (!name || !email || !date) {
                    showMessage('Please fill in all required fields', 'error');
                    return;
                }

                // Get signature data
                const signatureData = getSignatureData();
                if (!signatureData.data) {
                    showMessage('Please provide your signature', 'error');
                    return;
                }

                showMessage('Submitting CEO signature...', 'info');

                // Submit to backend
                const response = await fetch(`/api/agreements/submit-ceo-signature/${currentAgreementId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        signature: signatureData,
                        name: name,
                        title: document.getElementById('signerTitle').value.trim(),
                        email: email,
                        date: date
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showMessage('‚úÖ CEO signature submitted successfully! Thank you for signing the agreement.', 'success');
                    
                    // Show signed state after delay
                    setTimeout(() => {
                        showAlreadySigned();
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Failed to submit signature');
                }

            } catch (error) {
                console.error('Error submitting signature:', error);
                showMessage(`Error submitting signature: ${error.message}`, 'error');
            }
        }

        // Get signature data
        function getSignatureData() {
            const textInput = document.getElementById('signatureText');
            const canvas = document.getElementById('signatureCanvas');
            
            let signatureData = null;
            let signatureType = 'none';
            
            if (textInput && textInput.style.display !== 'none' && textInput.value.trim()) {
                signatureData = textInput.value.trim();
                signatureType = 'text';
            } else if (canvas && canvas.style.display !== 'none' && signaturePad && !signaturePad.isEmpty()) {
                signatureData = signaturePad.toDataURL();
                signatureType = 'drawn';
            }
            
            return {
                type: signatureType,
                data: signatureData,
                timestamp: new Date().toISOString()
            };
        }

        // Show error
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorState').innerHTML = `
                <h3>Error</h3>
                <p>${message}</p>
            `;
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('signatureMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : type === 'error' ? 'error-message' : 'loading';
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }
    </script>
</body>
</html>
